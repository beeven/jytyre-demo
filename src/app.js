"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
App({
    globalData: {
        useCloud: true
    },
    onLaunch() {
        if (!wx.cloud) {
            console.error('请使用 2.2.3 或以上的基础库以使用云能力');
        }
        else {
            wx.cloud.init({
                traceUser: true,
            });
        }
    },
    ensureLogin() {
        return new Promise((resolve, reject) => {
            if (this.globalData.openid !== null && typeof (this.globalData.openid) !== "undefined") {
                wx.checkSession({
                    success: () => {
                        resolve(this.globalData.openid);
                    },
                    fail: () => {
                        doLogin().then(openid => { resolve(openid); }).catch((err) => { reject(err); });
                    }
                });
            }
            else {
                doLogin().then(openid => { resolve(openid); }).catch(err => { reject(err); });
            }
        });
    },
    getUserInfo() {
        return new Promise((resolve, reject) => {
            wx.getSetting({
                success: res => {
                    if (res.authSetting["scope.userInfo"]) {
                        updateUserInfo().then((info) => {
                            resolve(info);
                        });
                    }
                    else {
                        this.ensureLogin().then(() => {
                            return updateUserInfo()
                                .then((info) => {
                                resolve(info);
                            });
                        });
                    }
                },
                fail: err => {
                    reject(err);
                }
            });
        });
    }
});
function doLogin() {
    const app = getApp();
    return new Promise((resolve, reject) => {
        wx.login({
            success: res => {
                if (res.code) {
                    if (app.globalData.useCloud) {
                        getOpenIDCloud().then(openid => {
                            resolve(openid);
                        });
                    }
                    else {
                        getOpenIDServer(res.code).then(openid => {
                            resolve(openid);
                        });
                    }
                }
            },
            fail: err => {
                reject(err);
            }
        });
    });
}
function getOpenIDCloud() {
    return new Promise((resolve, reject) => {
        const app = getApp();
        wx.cloud.callFunction({
            name: 'login',
            data: {},
            success: res => {
                console.log('[云函数] [login] user openid: ', res.result);
                let openid = res.result.openid;
                app.globalData.openid = openid;
                resolve(openid);
            },
            fail: err => {
                console.error('[云函数] [login] 调用失败', err);
                reject(err);
            }
        });
    });
}
function getOpenIDServer(code) {
    return new Promise((resolve, reject) => {
        const app = getApp();
        wx.request({
            url: 'https:/xxxxx/xxxx',
            data: {
                code: code
            },
            success: res => {
                app.globalData.openid = res.data.openid;
                resolve(res.data);
            },
            fail: err => {
                reject(err);
            }
        });
    });
}
function updateUserInfo() {
    return new Promise((resolve, reject) => {
        const app = getApp();
        wx.getUserInfo({
            success: res => {
                app.globalData.userInfo = res.userInfo;
                resolve(res.userInfo);
            },
            fail: err => {
                reject(err);
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBa0JBLEdBQUcsQ0FBQztJQUNGLFVBQVUsRUFBRTtRQUNWLFFBQVEsRUFBRSxJQUFJO0tBQ0s7SUFDckIsUUFBUTtRQUNOLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO1NBQ3pDO2FBQU07WUFDTCxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztnQkFDWixTQUFTLEVBQUUsSUFBSTthQUNoQixDQUFDLENBQUE7U0FHSDtJQUNILENBQUM7SUFFRCxXQUFXO1FBQ1QsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxLQUFLLElBQUksSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxXQUFXLEVBQUU7Z0JBQ3RGLEVBQUUsQ0FBQyxZQUFZLENBQUM7b0JBQ2QsT0FBTyxFQUFFLEdBQUcsRUFBRTt3QkFDWixPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDbEMsQ0FBQztvQkFDRCxJQUFJLEVBQUUsR0FBRyxFQUFFO3dCQUNULE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2hGLENBQUM7aUJBQ0YsQ0FBQyxDQUFBO2FBQ0g7aUJBQU07Z0JBQ0wsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FB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QUMsUUFBUSxDQUFDLENBQUM7WUFDeEIsQ0FBQztZQUNELElBQUksRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDVixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDZCxDQUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGludGVyZmFjZSBJTXlBcHBHbG9iYWxEYXRhIHtcbiAgdXNlckluZm8/OiB3eC5Vc2VySW5mbyxcbiAgdXNlQ2xvdWQ6IGJvb2xlYW4sXG4gIG9wZW5pZD86IHN0cmluZyxcbiAgcGhvbmVOdW1iZXI/OiBzdHJpbmcsXG4gIHRlc3Q/OiBzdHJpbmcgfCBvYmplY3QsXG4gIFtrZXk6IHN0cmluZ106IGFueVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElNeUFwcCB7XG4gIHVzZXJJbmZvUmVhZHlDYWxsYmFjaz8ocmVzOiB3eC5Vc2VySW5mbyk6IHZvaWQ7XG5cbiAgZ2xvYmFsRGF0YTogSU15QXBwR2xvYmFsRGF0YTtcblxuICBlbnN1cmVMb2dpbigpOiBQcm9taXNlPGFueT47XG4gIGdldFVzZXJJbmZvKCk6IFByb21pc2U8YW55Pjtcbn1cblxuQXBwKHtcbiAgZ2xvYmFsRGF0YToge1xuICAgIHVzZUNsb3VkOiB0cnVlXG4gIH0gYXMgSU15QXBwR2xvYmFsRGF0YSxcbiAgb25MYXVuY2goKSB7XG4gICAgaWYgKCF3eC5jbG91ZCkge1xuICAgICAgY29uc29sZS5lcnJvcign6K+35L2/55SoIDIuMi4zIOaIluS7peS4iueahOWfuuehgOW6k+S7peS9v+eUqOS6keiDveWKmycpXG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LmNsb3VkLmluaXQoe1xuICAgICAgICB0cmFjZVVzZXI6IHRydWUsXG4gICAgICB9KVxuXG5cbiAgICB9XG4gIH0sXG5cbiAgZW5zdXJlTG9naW4oKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh0aGlzLmdsb2JhbERhdGEub3BlbmlkICE9PSBudWxsICYmIHR5cGVvZiAodGhpcy5nbG9iYWxEYXRhLm9wZW5pZCkgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgd3guY2hlY2tTZXNzaW9uKHtcbiAgICAgICAgICBzdWNjZXNzOiAoKSA9PiB7XG4gICAgICAgICAgICByZXNvbHZlKHRoaXMuZ2xvYmFsRGF0YS5vcGVuaWQpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZmFpbDogKCkgPT4ge1xuICAgICAgICAgICAgZG9Mb2dpbigpLnRoZW4ob3BlbmlkID0+IHsgcmVzb2x2ZShvcGVuaWQpIH0pLmNhdGNoKChlcnIpID0+IHsgcmVqZWN0KGVycikgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZG9Mb2dpbigpLnRoZW4ob3BlbmlkID0+IHsgcmVzb2x2ZShvcGVuaWQpIH0pLmNhdGNoKGVyciA9PiB7IHJlamVjdChlcnIpIH0pO1xuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cbiAgZ2V0VXNlckluZm8oKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHd4LmdldFNldHRpbmcoe1xuICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICAgIGlmIChyZXMuYXV0aFNldHRpbmdbXCJzY29wZS51c2VySW5mb1wiXSkge1xuICAgICAgICAgICAgdXBkYXRlVXNlckluZm8oKS50aGVuKChpbmZvKSA9PiB7XG4gICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmVuc3VyZUxvZ2luKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiB1cGRhdGVVc2VySW5mbygpXG4gICAgICAgICAgICAgICAgLnRoZW4oKGluZm8pID0+IHtcbiAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZmFpbDogZXJyID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuXG4gIH1cblxufSlcblxuLy8gY2xhc3MgbXlBcHAgaW1wbGVtZW50cyBJTXlBcHAge1xuLy8gICBnbG9iYWxEYXRhOiBJTXlBcHBHbG9iYWxEYXRhID0ge1xuLy8gICAgIHVzZUNsb3VkOiB0cnVlLFxuXG4vLyAgIH1cblxuLy8gICBhc3luYyBvbkxhdW5jaCgpIHtcbi8vICAgICBpZiAoIXd4LmNsb3VkKSB7XG4vLyAgICAgICBjb25zb2xlLmVycm9yKCfor7fkvb/nlKggMi4yLjMg5oiW5Lul5LiK55qE5Z+656GA5bqT5Lul5L2/55So5LqR6IO95YqbJylcbi8vICAgICB9IGVsc2Uge1xuLy8gICAgICAgd3guY2xvdWQuaW5pdCh7XG4vLyAgICAgICAgIHRyYWNlVXNlcjogdHJ1ZSxcbi8vICAgICAgIH0pXG5cblxuLy8gICAgIH1cbi8vICAgICAvLyB0cnkge1xuLy8gICAgIC8vICAgYXdhaXQgdGhpcy5nZXRVc2VySW5mbygpXG4vLyAgICAgLy8gfSBjYXRjaCAoZXJyKSB7XG4vLyAgICAgLy8gICBjb25zb2xlLmVycm9yKGVycik7XG4vLyAgICAgLy8gfVxuLy8gICAgIC8vIGF3YWl0IHRoaXMuZ2V0VXNlckluZm8oKTtcbi8vICAgfVxuXG4vLyAgIGVuc3VyZUxvZ2luKCkge1xuLy8gICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4vLyAgICAgICBpZiAodGhpcy5nbG9iYWxEYXRhLm9wZW5pZCAhPT0gbnVsbCAmJiB0eXBlb2YgKHRoaXMuZ2xvYmFsRGF0YS5vcGVuaWQpICE9PSBcInVuZGVmaW5lZFwiKSB7XG4vLyAgICAgICAgIHd4LmNoZWNrU2Vzc2lvbih7XG4vLyAgICAgICAgICAgc3VjY2VzczogKCkgPT4ge1xuLy8gICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLmdsb2JhbERhdGEub3BlbmlkKTtcbi8vICAgICAgICAgICB9LFxuLy8gICAgICAgICAgIGZhaWw6ICgpID0+IHtcbi8vICAgICAgICAgICAgIGRvTG9naW4oKS50aGVuKG9wZW5pZCA9PiB7IHJlc29sdmUob3BlbmlkKSB9KS5jYXRjaCgoZXJyKSA9PiB7IHJlamVjdChlcnIpIH0pO1xuLy8gICAgICAgICAgIH1cbi8vICAgICAgICAgfSlcbi8vICAgICAgIH0gZWxzZSB7XG4vLyAgICAgICAgIGRvTG9naW4oKS50aGVuKG9wZW5pZCA9PiB7IHJlc29sdmUob3BlbmlkKSB9KS5jYXRjaChlcnIgPT4geyByZWplY3QoZXJyKSB9KTtcbi8vICAgICAgIH1cbi8vICAgICB9KVxuLy8gICB9XG5cbi8vICAgZ2V0VXNlckluZm8oKSB7XG4vLyAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbi8vICAgICAgIHd4LmdldFNldHRpbmcoe1xuLy8gICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xuLy8gICAgICAgICAgIGlmIChyZXMuYXV0aFNldHRpbmdbXCJzY29wZS51c2VySW5mb1wiXSkge1xuLy8gICAgICAgICAgICAgdXBkYXRlVXNlckluZm8oKS50aGVuKChpbmZvKSA9PiB7XG4vLyAgICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XG4vLyAgICAgICAgICAgICB9KVxuLy8gICAgICAgICAgIH0gZWxzZSB7XG4vLyAgICAgICAgICAgICB0aGlzLmVuc3VyZUxvZ2luKCkudGhlbigoKSA9PiB7XG4vLyAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVVc2VySW5mbygpXG4vLyAgICAgICAgICAgICAgICAgLnRoZW4oKGluZm8pID0+IHtcbi8vICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XG4vLyAgICAgICAgICAgICAgICAgfSlcbi8vICAgICAgICAgICAgIH0pO1xuLy8gICAgICAgICAgIH1cbi8vICAgICAgICAgfSxcbi8vICAgICAgICAgZmFpbDogZXJyID0+IHtcbi8vICAgICAgICAgICByZWplY3QoZXJyKTtcbi8vICAgICAgICAgfVxuLy8gICAgICAgfSlcbi8vICAgICB9KVxuXG4vLyAgIH1cbi8vIH1cblxuXG5mdW5jdGlvbiBkb0xvZ2luKCkge1xuICBjb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHd4LmxvZ2luKHtcbiAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgIGlmIChyZXMuY29kZSkge1xuICAgICAgICAgIGlmIChhcHAuZ2xvYmFsRGF0YS51c2VDbG91ZCkge1xuXG4gICAgICAgICAgICBnZXRPcGVuSURDbG91ZCgpLnRoZW4ob3BlbmlkID0+IHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShvcGVuaWQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGdldE9wZW5JRFNlcnZlcihyZXMuY29kZSkudGhlbihvcGVuaWQgPT4ge1xuICAgICAgICAgICAgICByZXNvbHZlKG9wZW5pZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBmYWlsOiBlcnIgPT4ge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cblxuZnVuY3Rpb24gZ2V0T3BlbklEQ2xvdWQoKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgYXBwID0gZ2V0QXBwPElNeUFwcD4oKTtcblxuICAgIHd4LmNsb3VkLmNhbGxGdW5jdGlvbih7XG4gICAgICBuYW1lOiAnbG9naW4nLFxuICAgICAgZGF0YToge30sXG4gICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygnW+S6keWHveaVsF0gW2xvZ2luXSB1c2VyIG9wZW5pZDogJywgcmVzLnJlc3VsdCk7XG4gICAgICAgIGxldCBvcGVuaWQgPSByZXMucmVzdWx0Lm9wZW5pZDtcbiAgICAgICAgYXBwLmdsb2JhbERhdGEub3BlbmlkID0gb3BlbmlkXG4gICAgICAgIHJlc29sdmUob3BlbmlkKTtcbiAgICAgIH0sXG4gICAgICBmYWlsOiBlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdb5LqR5Ye95pWwXSBbbG9naW5dIOiwg+eUqOWksei0pScsIGVycilcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG59XG5cbmZ1bmN0aW9uIGdldE9wZW5JRFNlcnZlcihjb2RlOiBzdHJpbmcpIHtcbiAgLy8gVE9ETzogaW1wbGVtZW50IFxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IGFwcCA9IGdldEFwcDxJTXlBcHA+KCk7XG4gICAgd3gucmVxdWVzdCh7XG4gICAgICB1cmw6ICdodHRwczoveHh4eHgveHh4eCcsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGNvZGU6IGNvZGVcbiAgICAgIH0sXG4gICAgICBzdWNjZXNzOiByZXMgPT4ge1xuICAgICAgICBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQgPSByZXMuZGF0YS5vcGVuaWQ7XG4gICAgICAgIHJlc29sdmUocmVzLmRhdGEpXG4gICAgICB9LFxuICAgICAgZmFpbDogZXJyID0+IHtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pXG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVVzZXJJbmZvKCkge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IGFwcCA9IGdldEFwcDxJTXlBcHA+KCk7XG4gICAgd3guZ2V0VXNlckluZm8oe1xuICAgICAgc3VjY2VzczogcmVzID0+IHtcbiAgICAgICAgYXBwLmdsb2JhbERhdGEudXNlckluZm8gPSByZXMudXNlckluZm87XG4gICAgICAgIHJlc29sdmUocmVzLnVzZXJJbmZvKTtcbiAgICAgIH0sXG4gICAgICBmYWlsOiBlcnIgPT4ge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSlcbn1cblxuXG4iXX0=