"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const warranty_service_1 = require("../warranty.service");
const moment = require("moment-mini-ts");
Page({
    data: {},
    async onLoad(options) {
        let warrantyID = options["id"];
        let ret = await warranty_service_1.warrantyService.getWarrantyItemDetail(warrantyID);
        console.log(ret);
        this.setData({
            warrantyID: warrantyID,
            plateNumber: ret.plateNumber || "",
            plateImageFileID: ret.plateImageFileID || "",
            shopName: ret.shopName || "",
            shopImageFileID: ret.shopImageFileID || "",
            shopAddress: ret.shopAddress || "",
            tyreModelImageFileID: ret.tyreModelImageFileID || "",
            tyreInstallationImageFileID: ret.tyreInstallationImageFileID || "",
            datePurchased: moment(ret.datePurchased).format("YYYY-MM-DD"),
            endDate: moment(ret.endDate).format("YYYY-MM-DD"),
            approvalStatus: ret.approvalStatus || warranty_service_1.ApprovalStatus.drafting,
            viewMode: ret.approvalStatus == warranty_service_1.ApprovalStatus.pending || ret.approvalStatus == warranty_service_1.ApprovalStatus.approved,
            canDelete: ret.approvalStatus == warranty_service_1.ApprovalStatus.drafting,
            shopLocation: ret.shopLocation ? {
                longtitude: ret.shopLocation.longtitude,
                latitude: ret.shopLocation.latitude
            } : undefined
        });
        let fileIDs = [{ name: "plateImageFileID", value: this.data.plateImageFileID },
            { name: "shopImageFileID", value: this.data.shopImageFileID },
            { name: "tyreModelImageFileID", value: this.data.tyreModelImageFileID },
            { name: "tyreInstallationImageFileID", value: this.data.tyreInstallationImageFileID }].filter(x => !!x.value);
        if (fileIDs.length > 0) {
            let urls = await wx.cloud.getTempFileURL({
                fileList: fileIDs.map(x => x.value),
            });
            let updates = {};
            urls.fileList.forEach(f => {
                let x = fileIDs.find(i => i.value == f.fileID);
                if (x && f.status == 0) {
                    updates[x.name.replace("ImageFileID", "ImageFileUrl")] = f.tempFileURL;
                }
            });
            this.setData(Object.assign({}, updates));
        }
    },
    async onUnload() {
        console.log("onUnload");
        let pages = getCurrentPages();
        let page = pages[pages.length - 2];
        await page.UpdateItem(this.data.warrantyID, {
            plateNumber: this.data.plateNumber || '车牌未填写',
            id: this.data.warrantyID,
            approvalStatus: warranty_service_1.ApprovalStatus.drafting,
            description: '',
            thumbnail: "",
            isDeleting: this.data.isDeleting
        });
        if (!this.data.isDeleting) {
            await warranty_service_1.warrantyService.updateWarrantyItem(this.data.warrantyID, {
                plateImageFileID: this.data.plateImageFileID,
                plateNumber: this.data.plateNumber,
                datePurchased: moment(this.data.datePurchased).toDate(),
                shopAddress: this.data.shopAddress,
                shopImageFileID: this.data.shopImageFileID,
                shopName: this.data.shopName,
                tyreModelImageFileID: this.data.tyreModelImageFileID,
                tyreInstallationImageFileID: this.data.tyreInstallationImageFileID
            }, this.data.shopLocation ? {
                longtitude: this.data.shopLocation.longtitude,
                latitude: this.data.shopLocation.latitude
            } : undefined);
        }
    },
    onDateChanged(e) {
        this.setData({
            datePurchased: e.detail.value
        });
    },
    onGetLocation() {
        wx.chooseLocation({
            success: res => {
                this.setData({
                    shopAddress: res.address,
                    shopLocation: {
                        latitude: +res.latitude,
                        longtitude: +res.longitude
                    },
                    shopName: res.name
                });
            },
            fail: err => {
                console.log(err);
                wx.showToast({
                    title: '获取定位失败',
                    icon: 'none',
                    duration: 2000
                });
            }
        });
    },
    async onScanPlate() {
        let imgFile;
        try {
            imgFile = await new Promise((resolve, reject) => {
                wx.chooseImage({
                    count: 1,
                    sizeType: ['compressed'],
                    sourceType: ['album', 'camera'],
                    success: (res) => {
                        resolve(res.tempFiles[0]);
                    },
                    fail: err => {
                        reject(err);
                    }
                });
            });
            this.setData({
                plateImageFileUrl: imgFile.path
            });
        }
        catch (err) {
            return;
        }
        try {
            wx.showLoading({ title: "图片上传中", mask: true });
            let fileID = await warranty_service_1.warrantyService.uploadImage(this.data.warrantyID, imgFile.path, "licensePlate");
            wx.showLoading({ title: "识别车牌中" });
            let ret = await warranty_service_1.warrantyService.getPlateNumber(fileID);
            wx.hideLoading();
            this.setData({
                plateNumber: ret.plateNumber,
                plateImageFileID: ret.fileID
            });
        }
        catch (err) {
            wx.hideLoading();
            wx.showModal({
                title: '提示',
                content: '照片识别失败，请按照要求重新上传',
                showCancel: false
            });
        }
    },
    async onPlateInput(e) {
        this.setData({
            plateNumber: e.detail.value
        });
    },
    async chooseImage(e) {
        let imageName = e.currentTarget.dataset["name"];
        let imageFile = await new Promise((resolve, reject) => {
            wx.chooseImage({
                sizeType: ['original'],
                success: res => {
                    resolve(res.tempFiles[0]);
                },
                fail: err => {
                    reject(err);
                }
            });
        });
        let fileID = await warranty_service_1.warrantyService.uploadImage(this.data.warrantyID, imageFile.path, imageName);
        let fileIDProperty = imageName + "ImageFileID";
        let fileUrlProperty = imageName + "ImageFileUrl";
        this.setData({
            [fileIDProperty]: fileID,
            [fileUrlProperty]: imageFile.path
        });
    },
    async onRemoveWarranty() {
        wx.showLoading({
            title: '提交中'
        });
        this.setData({
            isDeleting: true
        });
        await warranty_service_1.warrantyService.removeWarrantyItem(this.data.warrantyID);
        let pages = getCurrentPages();
        console.log(pages);
        let page = pages[pages.length - 2];
        wx.hideLoading();
        wx.navigateBack({
            delta: 1,
        });
    },
    async previewImage(e) {
        let name = e.currentTarget.dataset["name"];
        wx.previewImage({
            urls: [this.data[name + "ImageFileUrl"]]
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGV0YWlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMERBQXNFO0FBRXRFLHlDQUF5QztBQTJCekMsSUFBSSxDQUFDO0lBQ0QsSUFBSSxFQUFFLEVBRXFCO0lBRTNCLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTztRQUNoQixJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFFLENBQUM7UUFFaEMsSUFBSSxHQUFHLEdBQUcsTUFBTSxrQ0FBZSxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRWxFLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFakIsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNULFVBQVUsRUFBRSxVQUFVO1lBQ3RCLFdBQVcsRUFBRSxHQUFHLENBQUMsV0FBVyxJQUFJLEVBQUU7WUFDbEMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLGdCQUFnQixJQUFJLEVBQUU7WUFDNUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRLElBQUksRUFBRTtZQUM1QixlQUFlLEVBQUUsR0FBRyxDQUFDLGVBQWUsSUFBSSxFQUFFO1lBQzFDLFdBQVcsRUFBRSxHQUFHLENBQUMsV0FBVyxJQUFJLEVBQUU7WUFDbEMsb0JBQW9CLEVBQUUsR0FBRyxDQUFDLG9CQUFvQixJQUFJLEVBQUU7WUFDcEQsMkJBQTJCLEVBQUUsR0FBRyxDQUFDLDJCQUEyQixJQUFJLEVBQUU7WUFDbEUsYUFBYSxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUM3RCxPQUFPLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1lBQ2pELGNBQWMsRUFBRSxHQUFHLENBQUMsY0FBYyxJQUFJLGlDQUFjLENBQUMsUUFBUTtZQUM3RCxRQUFRLEVBQUUsR0FB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Q0FBQyxDQUFDO1FBQ25CLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBNEIsQ0FBQztRQUU5RCxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDakIsRUFBRSxDQUFDLFlBQVksQ0FBQztZQUNaLEtBQUssRUFBRSxDQUFDO1NBQ1gsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBYztRQUM3QixJQUFJLElBQUksR0FBRyxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQyxFQUFFLENBQUMsWUFBWSxDQUFDO1lBQ1osSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsY0FBYyxDQUFDLENBQUM7U0FDM0MsQ0FBQyxDQUFBO0lBQ04sQ0FBQztDQUNKLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyB3YXJyYW50eVNlcnZpY2UsIEFwcHJvdmFsU3RhdHVzIH0gZnJvbSAnLi4vd2FycmFudHkuc2VydmljZSc7XHJcblxyXG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSBcIm1vbWVudC1taW5pLXRzXCI7XHJcbmltcG9ydCB7IFdhcnJhbnR5UGFnZSB9IGZyb20gJy4uL3dhcnJhbnR5JztcclxuXHJcbmludGVyZmFjZSBXYXJyYW50eURldGFpbFBhZ2VEYXRhIHtcclxuICAgIHdhcnJhbnR5SUQ6IHN0cmluZztcclxuICAgIHNob3BOYW1lOiBzdHJpbmc7XHJcbiAgICBzaG9wSW1hZ2VGaWxlSUQ6IHN0cmluZztcclxuICAgIHNob3BJbWFnZUZpbGVVcmw6IHN0cmluZztcclxuICAgIHNob3BBZGRyZXNzOiBzdHJpbmc7XHJcbiAgICBzaG9wTG9jYXRpb24/OiB7XHJcbiAgICAgICAgbG9uZ3RpdHVkZTogbnVtYmVyLFxyXG4gICAgICAgIGxhdGl0dWRlOiBudW1iZXJcclxuICAgIH1cclxuICAgIGRhdGVQdXJjaGFzZWQ6IHN0cmluZztcclxuICAgIHBsYXRlTnVtYmVyOiBzdHJpbmc7XHJcbiAgICBwbGF0ZUltYWdlRmlsZUlEOiBzdHJpbmc7XHJcbiAgICBwbGF0ZUltYWdlRmlsZVVybDogc3RyaW5nO1xyXG4gICAgdHlyZU1vZGVsSW1hZ2VGaWxlSUQ6IHN0cmluZztcclxuICAgIHR5cmVNb2RlbEltYWdlRmlsZVVybDogc3RyaW5nO1xyXG4gICAgdHlyZUluc3RhbGxhdGlvbkltYWdlRmlsZUlEOiBzdHJpbmc7XHJcbiAgICB0eXJlSW5zdGFsbGF0aW9uSW1hZ2VGaWxlVXJsOiBzdHJpbmc7XHJcbiAgICB2aWV3TW9kZTogYm9vbGVhbjtcclxuICAgIGNhbkRlbGV0ZTogYm9vbGVhbjtcclxuICAgIGlzRGVsZXRpbmc6IGJvb2xlYW47XHJcbn1cclxuXHJcblxyXG5QYWdlKHtcclxuICAgIGRhdGE6IHtcclxuXHJcbiAgICB9IGFzIFdhcnJhbnR5RGV0YWlsUGFnZURhdGEsXHJcblxyXG4gICAgYXN5bmMgb25Mb2FkKG9wdGlvbnMpIHtcclxuICAgICAgICBsZXQgd2FycmFudHlJRCA9IG9wdGlvbnNbXCJpZFwiXSE7XHJcblxyXG4gICAgICAgIGxldCByZXQgPSBhd2FpdCB3YXJyYW50eVNlcnZpY2UuZ2V0V2FycmFudHlJdGVtRGV0YWlsKHdhcnJhbnR5SUQpO1xyXG5cclxuICAgICAgICBjb25zb2xlLmxvZyhyZXQpO1xyXG5cclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICB3YXJyYW50eUlEOiB3YXJyYW50eUlELFxyXG4gICAgICAgICAgICBwbGF0ZU51bWJlcjogcmV0LnBsYXRlTnVtYmVyIHx8IFwiXCIsXHJcbiAgICAgICAgICAgIHBsYXRlSW1hZ2VGaWxlSUQ6IHJldC5wbGF0ZUltYWdlRmlsZUlEIHx8IFwiXCIsXHJcbiAgICAgICAgICAgIHNob3BOYW1lOiByZXQuc2hvcE5hbWUgfHwgXCJcIixcclxuICAgICAgICAgICAgc2hvcEltYWdlRmlsZUlEOiByZXQuc2hvcEltYWdlRmlsZUlEIHx8IFwiXCIsXHJcbiAgICAgICAgICAgIHNob3BBZGRyZXNzOiByZXQuc2hvcEFkZHJlc3MgfHwgXCJcIixcclxuICAgICAgICAgICAgdHlyZU1vZGVsSW1hZ2VGaWxlSUQ6IHJldC50eXJlTW9kZWxJbWFnZUZpbGVJRCB8fCBcIlwiLFxyXG4gICAgICAgICAgICB0eXJlSW5zdGFsbGF0aW9uSW1hZ2VGaWxlSUQ6IHJldC50eXJlSW5zdGFsbGF0aW9uSW1hZ2VGaWxlSUQgfHwgXCJcIixcclxuICAgICAgICAgICAgZGF0ZVB1cmNoYXNlZDogbW9tZW50KHJldC5kYXRlUHVyY2hhc2VkKS5mb3JtYXQoXCJZWVlZLU1NLUREXCIpLFxyXG4gICAgICAgICAgICBlbmREYXRlOiBtb21lbnQocmV0LmVuZERhdGUpLmZvcm1hdChcIllZWVktTU0tRERcIiksXHJcbiAgICAgICAgICAgIGFwcHJvdmFsU3RhdHVzOiByZXQuYXBwcm92YWxTdGF0dXMgfHwgQXBwcm92YWxTdGF0dXMuZHJhZnRpbmcsXHJcbiAgICAgICAgICAgIHZpZXdNb2RlOiByZXQuYXBwcm92YWxTdGF0dXMgPT0gQXBwcm92YWxTdGF0dXMucGVuZGluZyB8fCByZXQuYXBwcm92YWxTdGF0dXMgPT0gQXBwcm92YWxTdGF0dXMuYXBwcm92ZWQsXHJcbiAgICAgICAgICAgIGNhbkRlbGV0ZTogcmV0LmFwcHJvdmFsU3RhdHVzID09IEFwcHJvdmFsU3RhdHVzLmRyYWZ0aW5nLFxyXG4gICAgICAgICAgICBzaG9wTG9jYXRpb246IHJldC5zaG9wTG9jYXRpb24gPyB7XHJcbiAgICAgICAgICAgICAgICBsb25ndGl0dWRlOiByZXQuc2hvcExvY2F0aW9uIS5sb25ndGl0dWRlLFxyXG4gICAgICAgICAgICAgICAgbGF0aXR1ZGU6IHJldC5zaG9wTG9jYXRpb24hLmxhdGl0dWRlXHJcbiAgICAgICAgICAgIH0gOiB1bmRlZmluZWRcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGV0IGZpbGVJRHMgPSBbeyBuYW1lOiBcInBsYXRlSW1hZ2VGaWxlSURcIiwgdmFsdWU6IHRoaXMuZGF0YS5wbGF0ZUltYWdlRmlsZUlEIH0sXHJcbiAgICAgICAgeyBuYW1lOiBcInNob3BJbWFnZUZpbGVJRFwiLCB2YWx1ZTogdGhpcy5kYXRhLnNob3BJbWFnZUZpbGVJRCB9LFxyXG4gICAgICAgIHsgbmFtZTogXCJ0eXJlTW9kZWxJbWFnZUZpbGVJRFwiLCB2YWx1ZTogdGhpcy5kYXRhLnR5cmVNb2RlbEltYWdlRmlsZUlEIH0sXHJcbiAgICAgICAgeyBuYW1lOiBcInR5cmVJbnN0YWxsYXRpb25JbWFnZUZpbGVJRFwiLCB2YWx1ZTogdGhpcy5kYXRhLnR5cmVJbnN0YWxsYXRpb25JbWFnZUZpbGVJRCB9XS5maWx0ZXIoeCA9PiAhIXgudmFsdWUpO1xyXG5cclxuXHJcbiAgICAgICAgaWYgKGZpbGVJRHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBsZXQgdXJscyA9IGF3YWl0IHd4LmNsb3VkLmdldFRlbXBGaWxlVVJMKHtcclxuICAgICAgICAgICAgICAgIGZpbGVMaXN0OiBmaWxlSURzLm1hcCh4ID0+IHgudmFsdWUpLFxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGxldCB1cGRhdGVzOiB7IFt4OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xyXG4gICAgICAgICAgICB1cmxzLmZpbGVMaXN0LmZvckVhY2goZiA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgeCA9IGZpbGVJRHMuZmluZChpID0+IGkudmFsdWUgPT0gZi5maWxlSUQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHggJiYgZi5zdGF0dXMgPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZXNbeC5uYW1lLnJlcGxhY2UoXCJJbWFnZUZpbGVJRFwiLCBcIkltYWdlRmlsZVVybFwiKV0gPSBmLnRlbXBGaWxlVVJMO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHsgLi4udXBkYXRlcyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIGFzeW5jIG9uVW5sb2FkKCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwib25VbmxvYWRcIilcclxuXHJcbiAgICAgICAgbGV0IHBhZ2VzID0gZ2V0Q3VycmVudFBhZ2VzKCk7XHJcbiAgICAgICAgbGV0IHBhZ2UgPSBwYWdlc1twYWdlcy5sZW5ndGggLSAyXSBhcyB1bmtub3duIGFzIFdhcnJhbnR5UGFnZTtcclxuICAgICAgICBhd2FpdCBwYWdlLlVwZGF0ZUl0ZW0odGhpcy5kYXRhLndhcnJhbnR5SUQsIHtcclxuICAgICAgICAgICAgcGxhdGVOdW1iZXI6IHRoaXMuZGF0YS5wbGF0ZU51bWJlciB8fCAn6L2m54mM5pyq5aGr5YaZJyxcclxuICAgICAgICAgICAgaWQ6IHRoaXMuZGF0YS53YXJyYW50eUlELFxyXG4gICAgICAgICAgICBhcHByb3ZhbFN0YXR1czogQXBwcm92YWxTdGF0dXMuZHJhZnRpbmcsXHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnJyxcclxuICAgICAgICAgICAgdGh1bWJuYWlsOiBcIlwiLFxyXG4gICAgICAgICAgICBpc0RlbGV0aW5nOiB0aGlzLmRhdGEuaXNEZWxldGluZ1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuZGF0YS5pc0RlbGV0aW5nKSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHdhcnJhbnR5U2VydmljZS51cGRhdGVXYXJyYW50eUl0ZW0odGhpcy5kYXRhLndhcnJhbnR5SUQsIHtcclxuICAgICAgICAgICAgICAgIHBsYXRlSW1hZ2VGaWxlSUQ6IHRoaXMuZGF0YS5wbGF0ZUltYWdlRmlsZUlELFxyXG4gICAgICAgICAgICAgICAgcGxhdGVOdW1iZXI6IHRoaXMuZGF0YS5wbGF0ZU51bWJlcixcclxuICAgICAgICAgICAgICAgIGRhdGVQdXJjaGFzZWQ6IG1vbWVudCh0aGlzLmRhdGEuZGF0ZVB1cmNoYXNlZCkudG9EYXRlKCksXHJcbiAgICAgICAgICAgICAgICBzaG9wQWRkcmVzczogdGhpcy5kYXRhLnNob3BBZGRyZXNzLFxyXG4gICAgICAgICAgICAgICAgc2hvcEltYWdlRmlsZUlEOiB0aGlzLmRhdGEuc2hvcEltYWdlRmlsZUlELFxyXG4gICAgICAgICAgICAgICAgc2hvcE5hbWU6IHRoaXMuZGF0YS5zaG9wTmFtZSxcclxuICAgICAgICAgICAgICAgIHR5cmVNb2RlbEltYWdlRmlsZUlEOiB0aGlzLmRhdGEudHlyZU1vZGVsSW1hZ2VGaWxlSUQsXHJcbiAgICAgICAgICAgICAgICB0eXJlSW5zdGFsbGF0aW9uSW1hZ2VGaWxlSUQ6IHRoaXMuZGF0YS50eXJlSW5zdGFsbGF0aW9uSW1hZ2VGaWxlSURcclxuICAgICAgICAgICAgfSwgdGhpcy5kYXRhLnNob3BMb2NhdGlvbiA/IHtcclxuICAgICAgICAgICAgICAgIGxvbmd0aXR1ZGU6IHRoaXMuZGF0YS5zaG9wTG9jYXRpb24hLmxvbmd0aXR1ZGUsXHJcbiAgICAgICAgICAgICAgICBsYXRpdHVkZTogdGhpcy5kYXRhLnNob3BMb2NhdGlvbiEubGF0aXR1ZGVcclxuICAgICAgICAgICAgfSA6IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkRhdGVDaGFuZ2VkKGU6IGV2ZW50LklucHV0KSB7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgZGF0ZVB1cmNoYXNlZDogZS5kZXRhaWwudmFsdWVcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkdldExvY2F0aW9uKCkge1xyXG4gICAgICAgIHd4LmNob29zZUxvY2F0aW9uKHtcclxuICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgc2hvcEFkZHJlc3M6IHJlcy5hZGRyZXNzLFxyXG4gICAgICAgICAgICAgICAgICAgIHNob3BMb2NhdGlvbjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXRpdHVkZTogK3Jlcy5sYXRpdHVkZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9uZ3RpdHVkZTogK3Jlcy5sb25naXR1ZGVcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHNob3BOYW1lOiByZXMubmFtZVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZhaWw6IGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcclxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogJ+iOt+WPluWumuS9jeWksei0pScsXHJcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogJ25vbmUnLFxyXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgYXN5bmMgb25TY2FuUGxhdGUoKSB7XHJcblxyXG4gICAgICAgIGxldCBpbWdGaWxlO1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpbWdGaWxlID0gYXdhaXQgbmV3IFByb21pc2U8d3guSW1hZ2VGaWxlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB3eC5jaG9vc2VJbWFnZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgY291bnQ6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgc2l6ZVR5cGU6IFsnY29tcHJlc3NlZCddLFxyXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVR5cGU6IFsnYWxidW0nLCAnY2FtZXJhJ10sXHJcbiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlcy50ZW1wRmlsZXNbMF0pXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBmYWlsOiBlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIHBsYXRlSW1hZ2VGaWxlVXJsOiBpbWdGaWxlLnBhdGhcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG5cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogXCLlm77niYfkuIrkvKDkuK1cIiwgbWFzazogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgbGV0IGZpbGVJRCA9IGF3YWl0IHdhcnJhbnR5U2VydmljZS51cGxvYWRJbWFnZSh0aGlzLmRhdGEud2FycmFudHlJRCwgaW1nRmlsZS5wYXRoLCBcImxpY2Vuc2VQbGF0ZVwiKTtcclxuICAgICAgICAgICAgLy93eC5oaWRlTG9hZGluZygpO1xyXG5cclxuICAgICAgICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogXCLor4bliKvovabniYzkuK1cIiB9KVxyXG4gICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgd2FycmFudHlTZXJ2aWNlLmdldFBsYXRlTnVtYmVyKGZpbGVJRCk7XHJcbiAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBwbGF0ZU51bWJlcjogcmV0LnBsYXRlTnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgcGxhdGVJbWFnZUZpbGVJRDogcmV0LmZpbGVJRFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICB3eC5oaWRlTG9hZGluZygpO1xyXG4gICAgICAgICAgICB3eC5zaG93TW9kYWwoe1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6ICfmj5DnpLonLFxyXG4gICAgICAgICAgICAgICAgY29udGVudDogJ+eFp+eJh+ivhuWIq+Wksei0pe+8jOivt+aMieeFp+imgeaxgumHjeaWsOS4iuS8oCcsXHJcbiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsOiBmYWxzZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgIH0sXHJcblxyXG4gICAgYXN5bmMgb25QbGF0ZUlucHV0KGU6IGV2ZW50LklucHV0Qmx1cikge1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIHBsYXRlTnVtYmVyOiBlLmRldGFpbC52YWx1ZVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuXHJcbiAgICBhc3luYyBjaG9vc2VJbWFnZShlOiBldmVudC5Ub3VjaCkge1xyXG4gICAgICAgIGxldCBpbWFnZU5hbWUgPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFtcIm5hbWVcIl07XHJcbiAgICAgICAgbGV0IGltYWdlRmlsZSA9IGF3YWl0IG5ldyBQcm9taXNlPHd4LkltYWdlRmlsZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB3eC5jaG9vc2VJbWFnZSh7XHJcbiAgICAgICAgICAgICAgICBzaXplVHlwZTogWydvcmlnaW5hbCddLFxyXG4gICAgICAgICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlcy50ZW1wRmlsZXNbMF0pXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZmFpbDogZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGV0IGZpbGVJRCA9IGF3YWl0IHdhcnJhbnR5U2VydmljZS51cGxvYWRJbWFnZSh0aGlzLmRhdGEud2FycmFudHlJRCwgaW1hZ2VGaWxlLnBhdGgsIGltYWdlTmFtZSk7XHJcbiAgICAgICAgbGV0IGZpbGVJRFByb3BlcnR5ID0gaW1hZ2VOYW1lICsgXCJJbWFnZUZpbGVJRFwiO1xyXG4gICAgICAgIGxldCBmaWxlVXJsUHJvcGVydHkgPSBpbWFnZU5hbWUgKyBcIkltYWdlRmlsZVVybFwiO1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIFtmaWxlSURQcm9wZXJ0eV06IGZpbGVJRCxcclxuICAgICAgICAgICAgW2ZpbGVVcmxQcm9wZXJ0eV06IGltYWdlRmlsZS5wYXRoXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGFzeW5jIG9uUmVtb3ZlV2FycmFudHkoKSB7XHJcbiAgICAgICAgd3guc2hvd0xvYWRpbmcoe1xyXG4gICAgICAgICAgICB0aXRsZTogJ+aPkOS6pOS4rSdcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBpc0RlbGV0aW5nOiB0cnVlXHJcbiAgICAgICAgfSlcclxuICAgICAgICBhd2FpdCB3YXJyYW50eVNlcnZpY2UucmVtb3ZlV2FycmFudHlJdGVtKHRoaXMuZGF0YS53YXJyYW50eUlEKTtcclxuICAgICAgICBsZXQgcGFnZXMgPSBnZXRDdXJyZW50UGFnZXMoKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhwYWdlcyk7XHJcbiAgICAgICAgbGV0IHBhZ2UgPSBwYWdlc1twYWdlcy5sZW5ndGggLSAyXSBhcyB1bmtub3duIGFzIFdhcnJhbnR5UGFnZTtcclxuICAgICAgICAvL2F3YWl0IHBhZ2Uub25JdGVtUmVtb3ZlZCh0aGlzLmRhdGEud2FycmFudHlJRCk7XHJcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKTtcclxuICAgICAgICB3eC5uYXZpZ2F0ZUJhY2soe1xyXG4gICAgICAgICAgICBkZWx0YTogMSxcclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBhc3luYyBwcmV2aWV3SW1hZ2UoZTogZXZlbnQuVG91Y2gpIHtcclxuICAgICAgICBsZXQgbmFtZSA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0W1wibmFtZVwiXTtcclxuICAgICAgICB3eC5wcmV2aWV3SW1hZ2Uoe1xyXG4gICAgICAgICAgICB1cmxzOiBbdGhpcy5kYXRhW25hbWUgKyBcIkltYWdlRmlsZVVybFwiXV1cclxuICAgICAgICB9KVxyXG4gICAgfVxyXG59KVxyXG4iXX0=