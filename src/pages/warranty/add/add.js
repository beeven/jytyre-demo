"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const warranty_service_1 = require("../warranty.service");
const moment = require("moment-mini-ts");
Page({
    data: {
        shopName: null,
        shopAddress: null,
        datePurchased: moment().format("YYYY-MM-DD"),
    },
    onLoad(options) {
        let warrantyID = options["id"];
        this.setData({
            warrantyID: warrantyID
        });
    },
    async onUnload() {
        let pages = getCurrentPages();
        console.log(pages);
        let page = pages[pages.length - 2];
        await page.onItemAdded(this.data.warrantyID, {
            plateNumber: this.data.plateNumber,
            id: this.data.warrantyID,
            approvalStatus: warranty_service_1.ApprovalStatus.drafting,
            description: '',
            thumbnail: ""
        });
        console.log(this.data);
        await warranty_service_1.warrantyService.updateWarrantyItem(this.data.warrantyID, {
            plateNumber: this.data.plateNumber
        }, this.data.shopLocation ? {
            longtitude: +this.data.shopLocation.longtitude,
            latitude: +this.data.shopLocation.latitude
        } : undefined);
    },
    onDateChanged(e) {
        console.log(e.detail.value);
        this.setData({
            datePurchased: e.detail.value
        });
    },
    onGetLocation() {
        wx.chooseLocation({
            success: res => {
                this.setData({
                    shopAddress: res.address,
                    shopLocation: {
                        latitude: +res.latitude,
                        longtitude: +res.longitude
                    },
                    shopName: res.name
                });
            },
            fail: err => {
                console.log(err);
                wx.showToast({
                    title: '获取定位失败',
                    icon: 'none',
                    duration: 2000
                });
            }
        });
    },
    async onScanPlate() {
        let imgFile = await new Promise((resolve, reject) => {
            wx.chooseImage({
                count: 1,
                sizeType: ['compressed'],
                sourceType: ['album', 'camera'],
                success: (res) => {
                    resolve(res.tempFiles[0]);
                },
                fail: err => {
                    reject(err);
                }
            });
        });
        console.log(imgFile.size);
        this.setData({
            plateImageFileID: "123",
            plateImageFilePath: imgFile.path
        });
        try {
            wx.showLoading({
                title: '数据上传中',
                mask: true
            });
            let ret = await warranty_service_1.warrantyService.uploadPlateImage(this.data.warrantyID, imgFile.path);
            wx.hideLoading();
            this.setData({
                plateNumber: ret.plateNumber,
                plateImageFileID: ret.fileID
            });
        }
        catch (err) {
            wx.hideLoading();
            wx.showModal({
                title: '提示',
                content: '照片识别失败，请按照要求重新上传',
                showCancel: false
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWRkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMERBQW9FO0FBRXBFLHlDQUF5QztBQWtCekMsSUFBSSxDQUFDO0lBQ0QsSUFBSSxFQUFFO1FBQ0YsUUFBUSxFQUFFLElBQUk7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixhQUFhLEVBQUUsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztLQUV4QjtJQUV4QixNQUFNLENBQUMsT0FBTztRQUNWLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1QsVUFBVSxFQUFFLFVBQVU7U0FDekIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRO1FBRVYsSUFBSSxLQUFLLEdBQUcsZUFBZSxFQUFFLENBQUM7UUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBQyxDQUFDLENBQTRCLENBQUM7UUFDNUQsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3pDLFdBQVcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVc7WUFDbEMsRUFBRSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVTtZQUN4QixjQUFjLEVBQUUsaUNBQWMsQ0FBQyxRQUFRO1lBQ3ZDLFdBQVcsRUFBRSxFQUFFO1lBQ2YsU0FBUyxFQUFFLEVBQUU7U0FDaEIsQ0FBQyxDQUFDO1FBR0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkIsTUFBTSxrQ0FBZSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQzNELFdB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Q0FBQyxDQUFDO1NBQ047UUFBQyxPQUFNLEdBQUcsRUFBRTtZQUNULEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNqQixFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNULEtBQUssRUFBRSxJQUFJO2dCQUNYLE9BQU8sRUFBRSxrQkFBa0I7Z0JBQzNCLFVBQVUsRUFBRSxLQUFLO2FBQ3BCLENBQUMsQ0FBQztTQUNOO0lBR0wsQ0FBQztDQUNKLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQge3dhcnJhbnR5U2VydmljZSwgQXBwcm92YWxTdGF0dXN9IGZyb20gJy4uL3dhcnJhbnR5LnNlcnZpY2UnO1xyXG5cclxuaW1wb3J0ICogYXMgbW9tZW50IGZyb20gXCJtb21lbnQtbWluaS10c1wiO1xyXG5pbXBvcnQgeyBXYXJyYW50eVBhZ2UgfSBmcm9tICcuLi93YXJyYW50eSc7XHJcblxyXG5pbnRlcmZhY2UgQWRkV2FycmFudHlQYWdlRGF0YSB7XHJcbiAgICB3YXJyYW50eUlEOiBzdHJpbmc7XHJcbiAgICBzaG9wTmFtZTogc3RyaW5nIHwgbnVsbDtcclxuICAgIHNob3BBZGRyZXNzIDogc3RyaW5nIHwgbnVsbDtcclxuICAgIHNob3BMb2NhdGlvbj86IHtcclxuICAgICAgICBsb25ndGl0dWRlOiBudW1iZXIsXHJcbiAgICAgICAgbGF0aXR1ZGU6IG51bWJlclxyXG4gICAgfVxyXG4gICAgZGF0ZVB1cmNoYXNlZDogc3RyaW5nO1xyXG4gICAgcGxhdGVOdW1iZXI6IHN0cmluZztcclxuICAgIHBsYXRlSW1hZ2VGaWxlSUQ6IHN0cmluZztcclxuICAgIHBsYXRlSW1hZ2VGaWxlUGF0aDogc3RyaW5nO1xyXG59XHJcblxyXG5cclxuUGFnZSh7XHJcbiAgICBkYXRhOiB7XHJcbiAgICAgICAgc2hvcE5hbWU6IG51bGwsXHJcbiAgICAgICAgc2hvcEFkZHJlc3M6IG51bGwsXHJcbiAgICAgICAgZGF0ZVB1cmNoYXNlZDogbW9tZW50KCkuZm9ybWF0KFwiWVlZWS1NTS1ERFwiKSxcclxuXHJcbiAgICB9IGFzIEFkZFdhcnJhbnR5UGFnZURhdGEsXHJcblxyXG4gICAgb25Mb2FkKG9wdGlvbnMpIHtcclxuICAgICAgICBsZXQgd2FycmFudHlJRCA9IG9wdGlvbnNbXCJpZFwiXTtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICB3YXJyYW50eUlEOiB3YXJyYW50eUlEXHJcbiAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGFzeW5jIG9uVW5sb2FkKCkge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBwYWdlcyA9IGdldEN1cnJlbnRQYWdlcygpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHBhZ2VzKTtcclxuICAgICAgICBsZXQgcGFnZSA9IHBhZ2VzW3BhZ2VzLmxlbmd0aC0yXSBhcyB1bmtub3duIGFzIFdhcnJhbnR5UGFnZTtcclxuICAgICAgICBhd2FpdCBwYWdlLm9uSXRlbUFkZGVkKHRoaXMuZGF0YS53YXJyYW50eUlELCB7XHJcbiAgICAgICAgICAgIHBsYXRlTnVtYmVyOiB0aGlzLmRhdGEucGxhdGVOdW1iZXIsXHJcbiAgICAgICAgICAgIGlkOiB0aGlzLmRhdGEud2FycmFudHlJRCxcclxuICAgICAgICAgICAgYXBwcm92YWxTdGF0dXM6IEFwcHJvdmFsU3RhdHVzLmRyYWZ0aW5nLFxyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogJycsXHJcbiAgICAgICAgICAgIHRodW1ibmFpbDogXCJcIlxyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5kYXRhKTtcclxuICAgICAgICBhd2FpdCB3YXJyYW50eVNlcnZpY2UudXBkYXRlV2FycmFudHlJdGVtKHRoaXMuZGF0YS53YXJyYW50eUlELCB7XHJcbiAgICAgICAgICAgIHBsYXRlTnVtYmVyOiB0aGlzLmRhdGEucGxhdGVOdW1iZXJcclxuICAgICAgICB9LCB0aGlzLmRhdGEuc2hvcExvY2F0aW9uID8gIHtcclxuICAgICAgICAgICAgbG9uZ3RpdHVkZTordGhpcy5kYXRhLnNob3BMb2NhdGlvbiEubG9uZ3RpdHVkZSxcclxuICAgICAgICAgICAgbGF0aXR1ZGU6K3RoaXMuZGF0YS5zaG9wTG9jYXRpb24hLmxhdGl0dWRlXHJcbiAgICAgICAgfTogdW5kZWZpbmVkKTtcclxuICAgIH0sXHJcblxyXG4gICAgb25EYXRlQ2hhbmdlZChlOiBldmVudC5JbnB1dCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGUuZGV0YWlsLnZhbHVlKVxyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIGRhdGVQdXJjaGFzZWQ6IGUuZGV0YWlsLnZhbHVlXHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgb25HZXRMb2NhdGlvbigpIHtcclxuICAgICAgICB3eC5jaG9vc2VMb2NhdGlvbih7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgICAgIHNob3BBZGRyZXNzOiByZXMuYWRkcmVzcyxcclxuICAgICAgICAgICAgICAgICAgICBzaG9wTG9jYXRpb246IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGF0aXR1ZGU6ICtyZXMubGF0aXR1ZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvbmd0aXR1ZGU6ICtyZXMubG9uZ2l0dWRlXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBzaG9wTmFtZTogcmVzLm5hbWVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBmYWlsOiBlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICfojrflj5blrprkvY3lpLHotKUnLFxyXG4gICAgICAgICAgICAgICAgICAgIGljb246ICdub25lJyxcclxuICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMjAwMFxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIGFzeW5jIG9uU2NhblBsYXRlKCkge1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBpbWdGaWxlID0gYXdhaXQgbmV3IFByb21pc2U8d3guSW1hZ2VGaWxlPigocmVzb2x2ZSxyZWplY3QpPT57XHJcbiAgICAgICAgICAgIHd4LmNob29zZUltYWdlKHtcclxuICAgICAgICAgICAgICAgIGNvdW50OiAxLFxyXG4gICAgICAgICAgICAgICAgc2l6ZVR5cGU6IFsnY29tcHJlc3NlZCddLFxyXG4gICAgICAgICAgICAgICAgc291cmNlVHlwZTogWydhbGJ1bScsICdjYW1lcmEnXSxcclxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IChyZXMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlcy50ZW1wRmlsZXNbMF0pXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZmFpbDogZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc29sZS5sb2coaW1nRmlsZS5zaXplKTtcclxuXHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgcGxhdGVJbWFnZUZpbGVJRDogXCIxMjNcIixcclxuICAgICAgICAgICAgcGxhdGVJbWFnZUZpbGVQYXRoOiBpbWdGaWxlLnBhdGhcclxuICAgICAgICB9KVxyXG5cclxuICAgIFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHd4LnNob3dMb2FkaW5nKHtcclxuICAgICAgICAgICAgICAgIHRpdGxlOiAn5pWw5o2u5LiK5Lyg5LitJyxcclxuICAgICAgICAgICAgICAgIG1hc2s6IHRydWVcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGxldCByZXQgPSBhd2FpdCB3YXJyYW50eVNlcnZpY2UudXBsb2FkUGxhdGVJbWFnZSh0aGlzLmRhdGEud2FycmFudHlJRCwgaW1nRmlsZS5wYXRoKTtcclxuICAgICAgICAgICAgd3guaGlkZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIHBsYXRlTnVtYmVyOiByZXQucGxhdGVOdW1iZXIsXHJcbiAgICAgICAgICAgICAgICBwbGF0ZUltYWdlRmlsZUlEOiByZXQuZmlsZUlEXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2goZXJyKSB7XHJcbiAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgIHd4LnNob3dNb2RhbCh7XHJcbiAgICAgICAgICAgICAgICB0aXRsZTogJ+aPkOekuicsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiAn54Wn54mH6K+G5Yir5aSx6LSl77yM6K+35oyJ54Wn6KaB5rGC6YeN5paw5LiK5LygJyxcclxuICAgICAgICAgICAgICAgIHNob3dDYW5jZWw6IGZhbHNlXHJcbiAgICAgICAgICAgIH0pOyAgIFxyXG4gICAgICAgIH0gXHJcblxyXG5cclxuICAgIH1cclxufSlcclxuIl19