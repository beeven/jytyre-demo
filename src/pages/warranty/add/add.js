"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const warranty_service_1 = require("../warranty.service");
const moment = require("moment-mini-ts");
Page({
    data: {
        shopName: null,
        shopAddress: null,
        datePurchased: moment().format("YYYY-MM-DD"),
    },
    onLoad(options) {
        let warrantyID = options["id"];
        this.setData({
            warrantyID: warrantyID
        });
    },
    async onUnload() {
        let pages = getCurrentPages();
        console.log(pages);
        let page = pages[pages.length - 2];
        await page.onItemAdded(this.data.warrantyID, {
            plateNumber: this.data.plateNumber || '车牌未填写',
            id: this.data.warrantyID,
            approvalStatus: warranty_service_1.ApprovalStatus.drafting,
            description: '',
            thumbnail: ""
        });
        console.log(this.data);
        await warranty_service_1.warrantyService.updateWarrantyItem(this.data.warrantyID, {
            plateNumber: this.data.plateNumber
        }, this.data.shopLocation ? {
            longtitude: +this.data.shopLocation.longtitude,
            latitude: +this.data.shopLocation.latitude
        } : undefined);
    },
    onDateChanged(e) {
        console.log(e.detail.value);
        this.setData({
            datePurchased: e.detail.value
        });
    },
    onGetLocation() {
        wx.chooseLocation({
            success: res => {
                this.setData({
                    shopAddress: res.address,
                    shopLocation: {
                        latitude: +res.latitude,
                        longtitude: +res.longitude
                    },
                    shopName: res.name
                });
            },
            fail: err => {
                console.log(err);
                wx.showToast({
                    title: '获取定位失败',
                    icon: 'none',
                    duration: 2000
                });
            }
        });
    },
    async onScanPlate() {
        let imgFile = await new Promise((resolve, reject) => {
            wx.chooseImage({
                count: 1,
                sizeType: ['compressed'],
                sourceType: ['album', 'camera'],
                success: (res) => {
                    resolve(res.tempFiles[0]);
                },
                fail: err => {
                    reject(err);
                }
            });
        });
        console.log(imgFile.size);
        this.setData({
            plateImageFileID: "123",
            plateImageFilePath: imgFile.path
        });
        try {
            wx.showLoading({
                title: '数据上传中',
                mask: true
            });
            let ret = await warranty_service_1.warrantyService.uploadPlateImage(this.data.warrantyID, imgFile.path);
            wx.hideLoading();
            this.setData({
                plateNumber: ret.plateNumber,
                plateImageFileID: ret.fileID
            });
        }
        catch (err) {
            wx.hideLoading();
            wx.showModal({
                title: '提示',
                content: '照片识别失败，请按照要求重新上传',
                showCancel: false
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWRkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMERBQW9FO0FBRXBFLHlDQUF5QztBQWtCekMsSUFBSSxDQUFDO0lBQ0QsSUFBSSxFQUFFO1FBQ0YsUUFBUSxFQUFFLElBQUk7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixhQUFhLEVBQUUsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztLQUV4QjtJQUV4QixNQUFNLENBQUMsT0FBTztRQUNWLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1QsVUFBVSxFQUFFLFVBQVU7U0FDekIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRO1FBRVYsSUFBSSxLQUFLLEdBQUcsZUFBZSxFQUFFLENBQUM7UUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQixJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBQyxDQUFDLENBQTRCLENBQUM7UUFDNUQsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3pDLFdBQVcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxPQUFPO1lBQzdDLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVU7WUFDeEIsY0FBYyxFQUFFLGlDQUFjLENBQUMsUUFBUTtZQUN2QyxXQUFXLEVBQUUsRUFBRTtZQUNmLFNBQVMsRUFBRSxFQUFFO1NBQ2hCLENBQUMsQ0FBQztRQUdILE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZCLE1BQU0sa0NBQWUsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFB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QUFNO2FBQy9CLENBQUMsQ0FBQztTQUNOO1FBQUMsT0FBTSxHQUFHLEVBQUU7WUFDVCxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakIsRUFBRSxDQUFDLFNBQVMsQ0FBQztnQkFDVCxLQUFLLEVBQUUsSUFBSTtnQkFDWCxPQUFPLEVBQUUsa0JBQWtCO2dCQUMzQixVQUFVLEVBQUUsS0FBSzthQUNwQixDQUFDLENBQUM7U0FDTjtJQUdMLENBQUM7Q0FDSixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHt3YXJyYW50eVNlcnZpY2UsIEFwcHJvdmFsU3RhdHVzfSBmcm9tICcuLi93YXJyYW50eS5zZXJ2aWNlJztcclxuXHJcbmltcG9ydCAqIGFzIG1vbWVudCBmcm9tIFwibW9tZW50LW1pbmktdHNcIjtcclxuaW1wb3J0IHsgV2FycmFudHlQYWdlIH0gZnJvbSAnLi4vd2FycmFudHknO1xyXG5cclxuaW50ZXJmYWNlIEFkZFdhcnJhbnR5UGFnZURhdGEge1xyXG4gICAgd2FycmFudHlJRDogc3RyaW5nO1xyXG4gICAgc2hvcE5hbWU6IHN0cmluZyB8IG51bGw7XHJcbiAgICBzaG9wQWRkcmVzcyA6IHN0cmluZyB8IG51bGw7XHJcbiAgICBzaG9wTG9jYXRpb24/OiB7XHJcbiAgICAgICAgbG9uZ3RpdHVkZTogbnVtYmVyLFxyXG4gICAgICAgIGxhdGl0dWRlOiBudW1iZXJcclxuICAgIH1cclxuICAgIGRhdGVQdXJjaGFzZWQ6IHN0cmluZztcclxuICAgIHBsYXRlTnVtYmVyOiBzdHJpbmc7XHJcbiAgICBwbGF0ZUltYWdlRmlsZUlEOiBzdHJpbmc7XHJcbiAgICBwbGF0ZUltYWdlRmlsZVBhdGg6IHN0cmluZztcclxufVxyXG5cclxuXHJcblBhZ2Uoe1xyXG4gICAgZGF0YToge1xyXG4gICAgICAgIHNob3BOYW1lOiBudWxsLFxyXG4gICAgICAgIHNob3BBZGRyZXNzOiBudWxsLFxyXG4gICAgICAgIGRhdGVQdXJjaGFzZWQ6IG1vbWVudCgpLmZvcm1hdChcIllZWVktTU0tRERcIiksXHJcblxyXG4gICAgfSBhcyBBZGRXYXJyYW50eVBhZ2VEYXRhLFxyXG5cclxuICAgIG9uTG9hZChvcHRpb25zKSB7XHJcbiAgICAgICAgbGV0IHdhcnJhbnR5SUQgPSBvcHRpb25zW1wiaWRcIl07XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgd2FycmFudHlJRDogd2FycmFudHlJRFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBhc3luYyBvblVubG9hZCgpIHtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgcGFnZXMgPSBnZXRDdXJyZW50UGFnZXMoKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhwYWdlcyk7XHJcbiAgICAgICAgbGV0IHBhZ2UgPSBwYWdlc1twYWdlcy5sZW5ndGgtMl0gYXMgdW5rbm93biBhcyBXYXJyYW50eVBhZ2U7XHJcbiAgICAgICAgYXdhaXQgcGFnZS5vbkl0ZW1BZGRlZCh0aGlzLmRhdGEud2FycmFudHlJRCwge1xyXG4gICAgICAgICAgICBwbGF0ZU51bWJlcjogdGhpcy5kYXRhLnBsYXRlTnVtYmVyIHx8ICfovabniYzmnKrloavlhpknLFxyXG4gICAgICAgICAgICBpZDogdGhpcy5kYXRhLndhcnJhbnR5SUQsXHJcbiAgICAgICAgICAgIGFwcHJvdmFsU3RhdHVzOiBBcHByb3ZhbFN0YXR1cy5kcmFmdGluZyxcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICcnLFxyXG4gICAgICAgICAgICB0aHVtYm5haWw6IFwiXCJcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIGNvbnNvbGUubG9nKHRoaXMuZGF0YSk7XHJcbiAgICAgICAgYXdhaXQgd2FycmFudHlTZXJ2aWNlLnVwZGF0ZVdhcnJhbnR5SXRlbSh0aGlzLmRhdGEud2FycmFudHlJRCwge1xyXG4gICAgICAgICAgICBwbGF0ZU51bWJlcjogdGhpcy5kYXRhLnBsYXRlTnVtYmVyXHJcbiAgICAgICAgfSwgdGhpcy5kYXRhLnNob3BMb2NhdGlvbiA/ICB7XHJcbiAgICAgICAgICAgIGxvbmd0aXR1ZGU6K3RoaXMuZGF0YS5zaG9wTG9jYXRpb24hLmxvbmd0aXR1ZGUsXHJcbiAgICAgICAgICAgIGxhdGl0dWRlOit0aGlzLmRhdGEuc2hvcExvY2F0aW9uIS5sYXRpdHVkZVxyXG4gICAgICAgIH06IHVuZGVmaW5lZCk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uRGF0ZUNoYW5nZWQoZTogZXZlbnQuSW5wdXQpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhlLmRldGFpbC52YWx1ZSlcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBkYXRlUHVyY2hhc2VkOiBlLmRldGFpbC52YWx1ZVxyXG4gICAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIG9uR2V0TG9jYXRpb24oKSB7XHJcbiAgICAgICAgd3guY2hvb3NlTG9jYXRpb24oe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICBzaG9wQWRkcmVzczogcmVzLmFkZHJlc3MsXHJcbiAgICAgICAgICAgICAgICAgICAgc2hvcExvY2F0aW9uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhdGl0dWRlOiArcmVzLmxhdGl0dWRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb25ndGl0dWRlOiArcmVzLmxvbmdpdHVkZVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgc2hvcE5hbWU6IHJlcy5uYW1lXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZmFpbDogZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xyXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiAn6I635Y+W5a6a5L2N5aSx6LSlJyxcclxuICAgICAgICAgICAgICAgICAgICBpY29uOiAnbm9uZScsXHJcbiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIwMDBcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgfSxcclxuXHJcbiAgICBhc3luYyBvblNjYW5QbGF0ZSgpIHtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgaW1nRmlsZSA9IGF3YWl0IG5ldyBQcm9taXNlPHd4LkltYWdlRmlsZT4oKHJlc29sdmUscmVqZWN0KT0+e1xyXG4gICAgICAgICAgICB3eC5jaG9vc2VJbWFnZSh7XHJcbiAgICAgICAgICAgICAgICBjb3VudDogMSxcclxuICAgICAgICAgICAgICAgIHNpemVUeXBlOiBbJ2NvbXByZXNzZWQnXSxcclxuICAgICAgICAgICAgICAgIHNvdXJjZVR5cGU6IFsnYWxidW0nLCAnY2FtZXJhJ10sXHJcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiAocmVzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXMudGVtcEZpbGVzWzBdKVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGZhaWw6IGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnNvbGUubG9nKGltZ0ZpbGUuc2l6ZSk7XHJcblxyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIHBsYXRlSW1hZ2VGaWxlSUQ6IFwiMTIzXCIsXHJcbiAgICAgICAgICAgIHBsYXRlSW1hZ2VGaWxlUGF0aDogaW1nRmlsZS5wYXRoXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICBcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB3eC5zaG93TG9hZGluZyh7XHJcbiAgICAgICAgICAgICAgICB0aXRsZTogJ+aVsOaNruS4iuS8oOS4rScsXHJcbiAgICAgICAgICAgICAgICBtYXNrOiB0cnVlXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgd2FycmFudHlTZXJ2aWNlLnVwbG9hZFBsYXRlSW1hZ2UodGhpcy5kYXRhLndhcnJhbnR5SUQsIGltZ0ZpbGUucGF0aCk7XHJcbiAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBwbGF0ZU51bWJlcjogcmV0LnBsYXRlTnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgcGxhdGVJbWFnZUZpbGVJRDogcmV0LmZpbGVJRFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoKGVycikge1xyXG4gICAgICAgICAgICB3eC5oaWRlTG9hZGluZygpO1xyXG4gICAgICAgICAgICB3eC5zaG93TW9kYWwoe1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6ICfmj5DnpLonLFxyXG4gICAgICAgICAgICAgICAgY29udGVudDogJ+eFp+eJh+ivhuWIq+Wksei0pe+8jOivt+aMieeFp+imgeaxgumHjeaWsOS4iuS8oCcsXHJcbiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsOiBmYWxzZVxyXG4gICAgICAgICAgICB9KTsgICBcclxuICAgICAgICB9IFxyXG5cclxuXHJcbiAgICB9XHJcbn0pXHJcbiJdfQ==