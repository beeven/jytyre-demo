"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const app = getApp();
Page({
    data: {
        avatarUrl: "/assets/user-unlogin.png",
        nickName: "未登录",
        phoneNumber: "",
        hasPhoneNumber: false,
        editPhoneNumber: false
    },
    async onLoad() {
        if (app.globalData.userInfo) {
            if (app.globalData.phoneNumber) {
                this.setData({
                    nickName: app.globalData.userInfo.nickName,
                    avatarUrl: app.globalData.userInfo.avatarUrl,
                    phoneNumber: app.globalData.phoneNumber,
                    hasPhoneNumber: true
                });
            }
            else {
                this.setData({
                    nickName: app.globalData.userInfo.nickName,
                    avatarUrl: app.globalData.userInfo.avatarUrl,
                });
                try {
                    await fillPhoneNumber(this);
                }
                catch (err) {
                    this.setData({
                        editPhoneNumber: true
                    });
                }
            }
        }
        else {
            await app.ensureLogin();
            let info = await app.getUserInfo();
            this.setData({
                nickName: info.nickName,
                avatarUrl: info.avatarUrl
            });
            try {
                await fillPhoneNumber(this);
            }
            catch (err) {
                this.setData({
                    editPhoneNumber: true
                });
            }
        }
    },
    inputedit(e) {
        let value = e.detail.value;
        this.setData({
            phoneNumber: value
        });
    },
    async saveInfo() {
        this.setData({
            hasPhoneNumber: true,
            editPhoneNumber: false
        });
        app.globalData.phoneNumber = this.data.phoneNumber;
        await saveUserInfo();
    },
    editNumber() {
        this.setData({
            hasPhoneNumber: false
        });
    },
    async onGetPhoneNumber(e) {
        if (e.detail.errMsg) {
            this.setData({
                editPhoneNumber: true
            });
        }
        else {
            let phoneNumber;
            if (e.detail.cloudID) {
                phoneNumber = await getPhoneNumberCloud(e.detail.cloudID);
            }
            else {
                phoneNumber = await getPhoneNumberServer(e.detail.encryptedData, e.detail.iv);
            }
            this.setData({
                phoneNumber: phoneNumber,
                hasPhoneNumber: true,
                editPhoneNumber: false
            });
        }
    }
});
async function fillPhoneNumber(page) {
    let phoneNumber = "";
    let user = await loadUserInfo();
    if (user.phoneNumber) {
        phoneNumber = user.phoneNumber;
        app.globalData.phoneNumber = phoneNumber;
        page.setData({
            phoneNumber: phoneNumber,
            hasPhoneNumber: true
        });
        return phoneNumber;
    }
    else {
        throw new Error("phoneNumber not found");
    }
}
async function saveUserInfo() {
    wx.showLoading({
        'title': '保存中'
    });
    if (app.globalData.useCloud && app.globalData.openid) {
        const db = wx.cloud.database();
        await db.collection("users").doc(app.globalData.openid).set({
            data: {
                phoneNumber: app.globalData.phoneNumber,
                nickName: app.globalData.userInfo.nickName,
                avatarUrl: app.globalData.userInfo.avatarUrl,
            }
        });
        wx.hideLoading();
        wx.showToast({
            title: '已保存',
            icon: 'success',
            duration: 1000
        });
    }
    else {
        wx.request({
            url: "https://xxxxx/xxx",
            method: "POST",
            data: ""
        });
    }
}
async function loadUserInfo() {
    if (app.globalData.useCloud && app.globalData.openid) {
        const db = wx.cloud.database();
        let res = await db.collection("users").doc(app.globalData.openid).get();
        console.log(res.data);
        return res.data;
    }
    else {
        wx.request({
            url: "https://xxxxx/xxx",
            method: "POST",
            data: "info"
        });
        throw new Error("Not implemented.");
    }
}
async function getPhoneNumberCloud(code) {
    let ret = await wx.cloud.callFunction({
        name: "updatePhoneNumber",
        data: {
            openid: app.globalData.openid,
            phoneNumber: wx.cloud.cloudID(code)
        }
    });
    return ret.result;
}
async function getPhoneNumberServer(encryptedData, iv) {
    await new Promise((resolve, reject) => {
        wx.request({
            url: "http://xxxx/xxx",
            method: "POST",
            data: {
                openid: app.globalData.openid,
                encryptedData: encryptedData,
                iv: iv
            },
            success: (res) => {
                resolve(res.data);
            },
            fail: err => {
                reject(err);
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlckNvbnNvbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1c2VyQ29uc29sZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLE1BQU0sR0FBRyxHQUFHLE1BQU0sRUFBVSxDQUFDO0FBWTdCLElBQUksQ0FBQztJQUNELElBQUksRUFBRztRQUNILFNBQVMsRUFBRSwwQkFBMEI7UUFDckMsUUFBUSxFQUFFLEtBQUs7UUFDZixXQUFXLEVBQUUsRUFBRTtRQUNmLGNBQWMsRUFBRSxLQUFLO1FBQ3JCLGVBQWUsRUFBRSxLQUFLO0tBQ3pCO0lBRUQsS0FBSyxDQUFDLE1BQU07UUFDUixJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFO1lBQ3pCLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUU7Z0JBQzVCLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1QsUUFBUSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLFFBQVE7b0JBQzFDLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxTQUFTO29CQUM1QyxXQUFXLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxXQUFXO29CQUN2QyxjQUFjLEVBQUUsSUFBSTtpQkFDdkIsQ0FBQyxDQUFDO2FBQ047aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFDVCxRQUFRLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsUUFBUTtvQkFDMUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLFNBQVM7aUJBQy9DLENBQUMsQ0FBQztnQkFDSCxJQUFJO29CQUNBLE1BQU0sZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUMvQjtnQkFBQyxPQUFNLEdBQUcsRUFBRTtvQkFDVCxJQUFJLENBQUMsT0FBTyxDQUFDO3dCQUNULGVBQWUsRUFBRSxJQUFJO3FCQUN4QixDQUFDLENBQUM7aUJBQ047YUFD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SSxDQUFDLENBQUE7WUFDckIsQ0FBQztZQUNELElBQUksRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDUixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEIsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFBO0FBRU4sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElNeUFwcCB9IGZyb20gXCIuLi8uLi9hcHBcIjtcclxuXHJcbi8vIHBhZ2VzL3VzZXJDb25zb2xlL3VzZXJDb25zb2xlLmpzXHJcblxyXG5cclxuY29uc3QgYXBwID0gZ2V0QXBwPElNeUFwcD4oKTtcclxuXHJcbmludGVyZmFjZSBVc2VyQ29uc29sZURhdGEge1xyXG4gICAgYXZhdGFyVXJsOiBzdHJpbmc7XHJcbiAgICBuaWNrTmFtZTogc3RyaW5nO1xyXG4gICAgcGhvbmVOdW1iZXI6IHN0cmluZztcclxuICAgIGhhc1Bob25lTnVtYmVyOiBib29sZWFuO1xyXG4gICAgZWRpdFBob25lTnVtYmVyOiBib29sZWFuXHJcbn1cclxuXHJcblxyXG5cclxuUGFnZSh7XHJcbiAgICBkYXRhOiAge1xyXG4gICAgICAgIGF2YXRhclVybDogXCIvYXNzZXRzL3VzZXItdW5sb2dpbi5wbmdcIixcclxuICAgICAgICBuaWNrTmFtZTogXCLmnKrnmbvlvZVcIixcclxuICAgICAgICBwaG9uZU51bWJlcjogXCJcIixcclxuICAgICAgICBoYXNQaG9uZU51bWJlcjogZmFsc2UsXHJcbiAgICAgICAgZWRpdFBob25lTnVtYmVyOiBmYWxzZVxyXG4gICAgfSxcclxuXHJcbiAgICBhc3luYyBvbkxvYWQoKSB7XHJcbiAgICAgICAgaWYgKGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvKSB7XHJcbiAgICAgICAgICAgIGlmIChhcHAuZ2xvYmFsRGF0YS5waG9uZU51bWJlcikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICBuaWNrTmFtZTogYXBwLmdsb2JhbERhdGEudXNlckluZm8ubmlja05hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsOiBhcHAuZ2xvYmFsRGF0YS51c2VySW5mby5hdmF0YXJVcmwsXHJcbiAgICAgICAgICAgICAgICAgICAgcGhvbmVOdW1iZXI6IGFwcC5nbG9iYWxEYXRhLnBob25lTnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgICAgIGhhc1Bob25lTnVtYmVyOiB0cnVlXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgbmlja05hbWU6IGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvLm5pY2tOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIGF2YXRhclVybDogYXBwLmdsb2JhbERhdGEudXNlckluZm8uYXZhdGFyVXJsLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGZpbGxQaG9uZU51bWJlcih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2goZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdFBob25lTnVtYmVyOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhd2FpdCBhcHAuZW5zdXJlTG9naW4oKTtcclxuICAgICAgICAgICAgbGV0IGluZm8gPSBhd2FpdCBhcHAuZ2V0VXNlckluZm8oKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBuaWNrTmFtZTogaW5mby5uaWNrTmFtZSxcclxuICAgICAgICAgICAgICAgIGF2YXRhclVybDogaW5mby5hdmF0YXJVcmxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICBhd2FpdCBmaWxsUGhvbmVOdW1iZXIodGhpcyk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICBlZGl0UGhvbmVOdW1iZXI6IHRydWVcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIGlucHV0ZWRpdChlOiBldmVudC5JbnB1dCkge1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IGUuZGV0YWlsLnZhbHVlO1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgIHBob25lTnVtYmVyOiB2YWx1ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBhc3luYyBzYXZlSW5mbygpIHtcclxuICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICBoYXNQaG9uZU51bWJlcjogdHJ1ZSxcclxuICAgICAgICAgICAgZWRpdFBob25lTnVtYmVyOiBmYWxzZVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgYXBwLmdsb2JhbERhdGEucGhvbmVOdW1iZXIgPSB0aGlzLmRhdGEucGhvbmVOdW1iZXI7XHJcbiAgICAgICAgYXdhaXQgc2F2ZVVzZXJJbmZvKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGVkaXROdW1iZXIoKSB7XHJcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgaGFzUGhvbmVOdW1iZXI6IGZhbHNlXHJcbiAgICAgICAgfSlcclxuICAgIH0sXHJcblxyXG4gICAgYXN5bmMgb25HZXRQaG9uZU51bWJlcihlOiBldmVudC5CdXR0b25HZXRQaG9uZU51bWJlcikge1xyXG4gICAgICAgIGlmKGUuZGV0YWlsLmVyck1zZykge1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgZWRpdFBob25lTnVtYmVyOiB0cnVlXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCBwaG9uZU51bWJlcjpzdHJpbmc7XHJcbiAgICAgICAgICAgIGlmKGUuZGV0YWlsLmNsb3VkSUQpIHtcclxuICAgICAgICAgICAgICAgIHBob25lTnVtYmVyID0gYXdhaXQgZ2V0UGhvbmVOdW1iZXJDbG91ZChlLmRldGFpbC5jbG91ZElEKVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBwaG9uZU51bWJlciA9IGF3YWl0IGdldFBob25lTnVtYmVyU2VydmVyKGUuZGV0YWlsLmVuY3J5cHRlZERhdGEhLCBlLmRldGFpbC5pdiEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICBwaG9uZU51bWJlcjogcGhvbmVOdW1iZXIsXHJcbiAgICAgICAgICAgICAgICBoYXNQaG9uZU51bWJlcjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGVkaXRQaG9uZU51bWJlcjogZmFsc2VcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuXHJcblxyXG5cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGZpbGxQaG9uZU51bWJlcihwYWdlOiBQYWdlLlBhZ2VJbnN0YW5jZTxVc2VyQ29uc29sZURhdGE+KSB7XHJcblxyXG4gICAgbGV0IHBob25lTnVtYmVyID0gXCJcIjtcclxuICAgIGxldCB1c2VyID0gYXdhaXQgbG9hZFVzZXJJbmZvKCk7XHJcbiAgICBpZiAodXNlciEucGhvbmVOdW1iZXIpIHtcclxuICAgICAgICBwaG9uZU51bWJlciA9IHVzZXIhLnBob25lTnVtYmVyXHJcbiAgICAgICAgYXBwLmdsb2JhbERhdGEucGhvbmVOdW1iZXIgPSBwaG9uZU51bWJlcjtcclxuICAgICAgICBwYWdlLnNldERhdGEoe1xyXG4gICAgICAgICAgICBwaG9uZU51bWJlcjogcGhvbmVOdW1iZXIsXHJcbiAgICAgICAgICAgIGhhc1Bob25lTnVtYmVyOiB0cnVlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHBob25lTnVtYmVyO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwaG9uZU51bWJlciBub3QgZm91bmRcIik7XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBzYXZlVXNlckluZm8oKSB7XHJcbiAgICB3eC5zaG93TG9hZGluZyh7XHJcbiAgICAgICAgJ3RpdGxlJzogJ+S/neWtmOS4rSdcclxuICAgIH0pO1xyXG4gICAgaWYgKGFwcC5nbG9iYWxEYXRhLnVzZUNsb3VkICYmIGFwcC5nbG9iYWxEYXRhLm9wZW5pZCkge1xyXG4gICAgICAgIGNvbnN0IGRiID0gd3guY2xvdWQuZGF0YWJhc2UoKTtcclxuICAgICAgICBhd2FpdCBkYi5jb2xsZWN0aW9uKFwidXNlcnNcIikuZG9jKGFwcC5nbG9iYWxEYXRhLm9wZW5pZCkuc2V0KHtcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgcGhvbmVOdW1iZXI6IGFwcC5nbG9iYWxEYXRhLnBob25lTnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgbmlja05hbWU6IGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvIS5uaWNrTmFtZSxcclxuICAgICAgICAgICAgICAgIGF2YXRhclVybDogYXBwLmdsb2JhbERhdGEudXNlckluZm8hLmF2YXRhclVybCxcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XHJcbiAgICAgICAgd3guc2hvd1RvYXN0KHtcclxuICAgICAgICAgICAgdGl0bGU6ICflt7Lkv53lrZgnLFxyXG4gICAgICAgICAgICBpY29uOiAnc3VjY2VzcycsXHJcbiAgICAgICAgICAgIGR1cmF0aW9uOiAxMDAwXHJcbiAgICAgICAgfSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gVE9ETzogc2F2ZSB1c2VyIHRvIHNlcnZlciBsb2dpY1xyXG4gICAgICAgIHd4LnJlcXVlc3Qoe1xyXG4gICAgICAgICAgICB1cmw6IFwiaHR0cHM6Ly94eHh4eC94eHhcIixcclxuICAgICAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcclxuICAgICAgICAgICAgZGF0YTogXCJcIlxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGxvYWRVc2VySW5mbygpIHtcclxuICAgIGlmIChhcHAuZ2xvYmFsRGF0YS51c2VDbG91ZCAmJiBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQpIHtcclxuICAgICAgICBjb25zdCBkYiA9IHd4LmNsb3VkLmRhdGFiYXNlKCk7XHJcbiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IGRiLmNvbGxlY3Rpb24oXCJ1c2Vyc1wiKS5kb2MoYXBwLmdsb2JhbERhdGEub3BlbmlkKS5nZXQoKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhyZXMuZGF0YSk7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5kYXRhO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBUT0RPOiBsb2FkIHVzZXIgZnJvbSBzZXJ2ZXIgbG9naWNcclxuICAgICAgICB3eC5yZXF1ZXN0KHtcclxuICAgICAgICAgICAgdXJsOiBcImh0dHBzOi8veHh4eHgveHh4XCIsXHJcbiAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXHJcbiAgICAgICAgICAgIGRhdGE6IFwiaW5mb1wiXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IGltcGxlbWVudGVkLlwiKVxyXG5cclxuICAgIH1cclxufVxyXG5cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldFBob25lTnVtYmVyQ2xvdWQoY29kZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgcmV0ID0gYXdhaXQgd3guY2xvdWQuY2FsbEZ1bmN0aW9uKHtcclxuICAgICAgICAgICAgbmFtZTogXCJ1cGRhdGVQaG9uZU51bWJlclwiLFxyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICBvcGVuaWQ6IGFwcC5nbG9iYWxEYXRhLm9wZW5pZCxcclxuICAgICAgICAgICAgICAgIHBob25lTnVtYmVyOiB3eC5jbG91ZC5jbG91ZElEKGNvZGUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIHJldHVybiByZXQucmVzdWx0O1xyXG59IFxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZ2V0UGhvbmVOdW1iZXJTZXJ2ZXIoZW5jcnlwdGVkRGF0YTogc3RyaW5nLCBpdjogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpPT57XHJcbiAgICAgICAgd3gucmVxdWVzdCh7XHJcbiAgICAgICAgICAgIHVybDogXCJodHRwOi8veHh4eC94eHhcIixcclxuICAgICAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgb3BlbmlkOiBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQsXHJcbiAgICAgICAgICAgICAgICBlbmNyeXB0ZWREYXRhOiBlbmNyeXB0ZWREYXRhLFxyXG4gICAgICAgICAgICAgICAgaXY6IGl2XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IChyZXMpPT57XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlcy5kYXRhKSAgICBcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZmFpbDogZXJyID0+e1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pXHJcbiAgICBcclxufSJdfQ==