"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const app = getApp();
Page({
    data: {
        avatarUrl: "/assets/user-unlogin.png",
        nickName: "未登录",
        phoneNumber: "",
        hasPhoneNumber: false,
        editPhoneNumber: false
    },
    async onLoad() {
        if (app.globalData.userInfo) {
            if (app.globalData.phoneNumber) {
                this.setData({
                    nickName: app.globalData.userInfo.nickName,
                    avatarUrl: app.globalData.userInfo.avatarUrl,
                    phoneNumber: app.globalData.phoneNumber,
                    hasPhoneNumber: true
                });
            }
            else {
                this.setData({
                    nickName: app.globalData.userInfo.nickName,
                    avatarUrl: app.globalData.userInfo.avatarUrl,
                });
                try {
                    await fillPhoneNumber(this);
                }
                catch (err) {
                    this.setData({
                        editPhoneNumber: true
                    });
                }
            }
        }
        else {
            await app.ensureLogin();
            let info = await app.getUserInfo();
            this.setData({
                nickName: info.nickName,
                avatarUrl: info.avatarUrl
            });
            try {
                await fillPhoneNumber(this);
            }
            catch (err) {
                this.setData({
                    editPhoneNumber: true
                });
            }
        }
    },
    inputedit(e) {
        let value = e.detail.value;
        this.setData({
            phoneNumber: value
        });
    },
    async saveInfo() {
        this.setData({
            hasPhoneNumber: true,
            editPhoneNumber: false
        });
        app.globalData.phoneNumber = this.data.phoneNumber;
        await saveUserInfo();
    },
    editNumber() {
        this.setData({
            hasPhoneNumber: false
        });
    },
    async onGetPhoneNumber(e) {
        if (e.detail.errMsg) {
            wx.showToast({
                title: '无法获得授权，请输入',
                icon: 'none',
                duration: 1000
            });
            this.setData({
                editPhoneNumber: true
            });
        }
        else {
            let phoneNumber;
            if (e.detail.cloudID) {
                phoneNumber = await getPhoneNumberCloud(e.detail.cloudID);
            }
            else {
                phoneNumber = await getPhoneNumberServer(e.detail.encryptedData, e.detail.iv);
            }
            this.setData({
                phoneNumber: phoneNumber,
                hasPhoneNumber: true,
                editPhoneNumber: false
            });
        }
    }
});
async function fillPhoneNumber(page) {
    let phoneNumber = "";
    let user = await loadUserInfo();
    if (user.phoneNumber) {
        phoneNumber = user.phoneNumber;
        app.globalData.phoneNumber = phoneNumber;
        page.setData({
            phoneNumber: phoneNumber,
            hasPhoneNumber: true
        });
        return phoneNumber;
    }
    else {
        throw new Error("phoneNumber not found");
    }
}
async function saveUserInfo() {
    wx.showLoading({
        'title': '保存中'
    });
    if (app.globalData.useCloud && app.globalData.openid) {
        const db = wx.cloud.database();
        await db.collection("users").doc(app.globalData.openid).set({
            data: {
                phoneNumber: app.globalData.phoneNumber,
                nickName: app.globalData.userInfo.nickName,
                avatarUrl: app.globalData.userInfo.avatarUrl,
            }
        });
        wx.hideLoading();
        wx.showToast({
            title: '已保存',
            icon: 'success',
            duration: 1000
        });
    }
    else {
        wx.request({
            url: "https://xxxxx/xxx",
            method: "POST",
            data: ""
        });
    }
}
async function loadUserInfo() {
    if (app.globalData.useCloud && app.globalData.openid) {
        const db = wx.cloud.database();
        let res = await db.collection("users").doc(app.globalData.openid).get();
        console.log(res.data);
        return res.data;
    }
    else {
        wx.request({
            url: "https://xxxxx/xxx",
            method: "POST",
            data: "info"
        });
        throw new Error("Not implemented.");
    }
}
async function getPhoneNumberCloud(code) {
    let ret = await wx.cloud.callFunction({
        name: "updatePhoneNumber",
        data: {
            openid: app.globalData.openid,
            phoneNumber: wx.cloud.cloudID(code)
        }
    });
    return ret.result;
}
async function getPhoneNumberServer(encryptedData, iv) {
    await new Promise((resolve, reject) => {
        wx.request({
            url: "http://xxxx/xxx",
            method: "POST",
            data: {
                openid: app.globalData.openid,
                encryptedData: encryptedData,
                iv: iv
            },
            success: (res) => {
                resolve(res.data);
            },
            fail: err => {
                reject(err);
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlckNvbnNvbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1c2VyQ29uc29sZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLE1BQU0sR0FBRyxHQUFHLE1BQU0sRUFBVSxDQUFDO0FBWTdCLElBQUksQ0FBQztJQUNELElBQUksRUFBRztRQUNILFNBQVMsRUFBRSwwQkFBMEI7UUFDckMsUUFBUSxFQUFFLEtBQUs7UUFDZixXQUFXLEVBQUUsRUFBRTtRQUNmLGNBQWMsRUFBRSxLQUFLO1FBQ3JCLGVBQWUsRUFBRSxLQUFLO0tBQ3pCO0lBRUQsS0FBSyxDQUFDLE1BQU07UUFDUixJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFO1lBQ3pCLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUU7Z0JBQzVCLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1QsUUFBUSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLFFBQVE7b0JBQzFDLFNBQVMsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxTQUFTO29CQUM1QyxXQUFXLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxXQUFXO29CQUN2QyxjQUFjLEVBQUUsSUFBSTtpQkFDdkIsQ0FBQyxDQUFDO2FBQ047aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFDVCxRQUFRLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsUUFBUTtvQkFDMUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLFNBQVM7aUJBQy9DLENBQUMsQ0FBQztnQkFDSCxJQUFJO29CQUNBLE1BQU0sZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUMvQjtnQkFBQyxPQUFNLEdBQUcsRUFBRTtvQkFDVCxJQUFJLENBQUMsT0FBTyxDQUFDO3dCQUNULGVBQWUsRUFBRSxJQUFJO3FCQUN4QixDQUFDLENBQUM7aUJBQ047YUFD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QUFhLEVBQUUsYUFBYTtnQkFDNUIsRUFBRSxFQUFFLEVBQUU7YUFDVDtZQUNELE9BQU8sRUFBRSxDQUFDLEdBQUcsRUFBQyxFQUFFO2dCQUNaLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDckIsQ0FBQztZQUNELElBQUksRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDUixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEIsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFBO0FBRU4sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElNeUFwcCB9IGZyb20gXCIuLi8uLi9hcHBcIjtcblxuLy8gcGFnZXMvdXNlckNvbnNvbGUvdXNlckNvbnNvbGUuanNcblxuXG5jb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xuXG5pbnRlcmZhY2UgVXNlckNvbnNvbGVEYXRhIHtcbiAgICBhdmF0YXJVcmw6IHN0cmluZztcbiAgICBuaWNrTmFtZTogc3RyaW5nO1xuICAgIHBob25lTnVtYmVyOiBzdHJpbmc7XG4gICAgaGFzUGhvbmVOdW1iZXI6IGJvb2xlYW47XG4gICAgZWRpdFBob25lTnVtYmVyOiBib29sZWFuXG59XG5cblxuXG5QYWdlKHtcbiAgICBkYXRhOiAge1xuICAgICAgICBhdmF0YXJVcmw6IFwiL2Fzc2V0cy91c2VyLXVubG9naW4ucG5nXCIsXG4gICAgICAgIG5pY2tOYW1lOiBcIuacqueZu+W9lVwiLFxuICAgICAgICBwaG9uZU51bWJlcjogXCJcIixcbiAgICAgICAgaGFzUGhvbmVOdW1iZXI6IGZhbHNlLFxuICAgICAgICBlZGl0UGhvbmVOdW1iZXI6IGZhbHNlXG4gICAgfSxcblxuICAgIGFzeW5jIG9uTG9hZCgpIHtcbiAgICAgICAgaWYgKGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvKSB7XG4gICAgICAgICAgICBpZiAoYXBwLmdsb2JhbERhdGEucGhvbmVOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBuaWNrTmFtZTogYXBwLmdsb2JhbERhdGEudXNlckluZm8ubmlja05hbWUsXG4gICAgICAgICAgICAgICAgICAgIGF2YXRhclVybDogYXBwLmdsb2JhbERhdGEudXNlckluZm8uYXZhdGFyVXJsLFxuICAgICAgICAgICAgICAgICAgICBwaG9uZU51bWJlcjogYXBwLmdsb2JhbERhdGEucGhvbmVOdW1iZXIsXG4gICAgICAgICAgICAgICAgICAgIGhhc1Bob25lTnVtYmVyOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgICAgIG5pY2tOYW1lOiBhcHAuZ2xvYmFsRGF0YS51c2VySW5mby5uaWNrTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgYXZhdGFyVXJsOiBhcHAuZ2xvYmFsRGF0YS51c2VySW5mby5hdmF0YXJVcmwsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZmlsbFBob25lTnVtYmVyKHRoaXMpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2goZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBlZGl0UGhvbmVOdW1iZXI6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXdhaXQgYXBwLmVuc3VyZUxvZ2luKCk7XG4gICAgICAgICAgICBsZXQgaW5mbyA9IGF3YWl0IGFwcC5nZXRVc2VySW5mbygpO1xuXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIG5pY2tOYW1lOiBpbmZvLm5pY2tOYW1lLFxuICAgICAgICAgICAgICAgIGF2YXRhclVybDogaW5mby5hdmF0YXJVcmxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICBhd2FpdCBmaWxsUGhvbmVOdW1iZXIodGhpcyk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgICAgICBlZGl0UGhvbmVOdW1iZXI6IHRydWVcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIGlucHV0ZWRpdChlOiBldmVudC5JbnB1dCkge1xuICAgICAgICBsZXQgdmFsdWUgPSBlLmRldGFpbC52YWx1ZTtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHBob25lTnVtYmVyOiB2YWx1ZVxuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgYXN5bmMgc2F2ZUluZm8oKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBoYXNQaG9uZU51bWJlcjogdHJ1ZSxcbiAgICAgICAgICAgIGVkaXRQaG9uZU51bWJlcjogZmFsc2VcbiAgICAgICAgfSlcbiAgICAgICAgYXBwLmdsb2JhbERhdGEucGhvbmVOdW1iZXIgPSB0aGlzLmRhdGEucGhvbmVOdW1iZXI7XG4gICAgICAgIGF3YWl0IHNhdmVVc2VySW5mbygpO1xuICAgIH0sXG5cbiAgICBlZGl0TnVtYmVyKCkge1xuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgaGFzUGhvbmVOdW1iZXI6IGZhbHNlXG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIGFzeW5jIG9uR2V0UGhvbmVOdW1iZXIoZTogZXZlbnQuQnV0dG9uR2V0UGhvbmVOdW1iZXIpIHtcbiAgICAgICAgaWYoZS5kZXRhaWwuZXJyTXNnKSB7XG4gICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiAn5peg5rOV6I635b6X5o6I5p2D77yM6K+36L6T5YWlJyxcbiAgICAgICAgICAgICAgICBpY29uOiAnbm9uZScsXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IDEwMDBcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIGVkaXRQaG9uZU51bWJlcjogdHJ1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgcGhvbmVOdW1iZXI6c3RyaW5nO1xuICAgICAgICAgICAgaWYoZS5kZXRhaWwuY2xvdWRJRCkge1xuICAgICAgICAgICAgICAgIHBob25lTnVtYmVyID0gYXdhaXQgZ2V0UGhvbmVOdW1iZXJDbG91ZChlLmRldGFpbC5jbG91ZElEKVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwaG9uZU51bWJlciA9IGF3YWl0IGdldFBob25lTnVtYmVyU2VydmVyKGUuZGV0YWlsLmVuY3J5cHRlZERhdGEhLCBlLmRldGFpbC5pdiEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICBwaG9uZU51bWJlcjogcGhvbmVOdW1iZXIsXG4gICAgICAgICAgICAgICAgaGFzUGhvbmVOdW1iZXI6IHRydWUsXG4gICAgICAgICAgICAgICAgZWRpdFBob25lTnVtYmVyOiBmYWxzZVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH1cbn0pO1xuXG5cblxuXG5cbmFzeW5jIGZ1bmN0aW9uIGZpbGxQaG9uZU51bWJlcihwYWdlOiBQYWdlLlBhZ2VJbnN0YW5jZTxVc2VyQ29uc29sZURhdGE+KSB7XG5cbiAgICBsZXQgcGhvbmVOdW1iZXIgPSBcIlwiO1xuICAgIGxldCB1c2VyID0gYXdhaXQgbG9hZFVzZXJJbmZvKCk7XG4gICAgaWYgKHVzZXIhLnBob25lTnVtYmVyKSB7XG4gICAgICAgIHBob25lTnVtYmVyID0gdXNlciEucGhvbmVOdW1iZXJcbiAgICAgICAgYXBwLmdsb2JhbERhdGEucGhvbmVOdW1iZXIgPSBwaG9uZU51bWJlcjtcbiAgICAgICAgcGFnZS5zZXREYXRhKHtcbiAgICAgICAgICAgIHBob25lTnVtYmVyOiBwaG9uZU51bWJlcixcbiAgICAgICAgICAgIGhhc1Bob25lTnVtYmVyOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcGhvbmVOdW1iZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwicGhvbmVOdW1iZXIgbm90IGZvdW5kXCIpO1xuICAgIH1cblxufVxuXG5hc3luYyBmdW5jdGlvbiBzYXZlVXNlckluZm8oKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoe1xuICAgICAgICAndGl0bGUnOiAn5L+d5a2Y5LitJ1xuICAgIH0pO1xuICAgIGlmIChhcHAuZ2xvYmFsRGF0YS51c2VDbG91ZCAmJiBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQpIHtcbiAgICAgICAgY29uc3QgZGIgPSB3eC5jbG91ZC5kYXRhYmFzZSgpO1xuICAgICAgICBhd2FpdCBkYi5jb2xsZWN0aW9uKFwidXNlcnNcIikuZG9jKGFwcC5nbG9iYWxEYXRhLm9wZW5pZCkuc2V0KHtcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICBwaG9uZU51bWJlcjogYXBwLmdsb2JhbERhdGEucGhvbmVOdW1iZXIsXG4gICAgICAgICAgICAgICAgbmlja05hbWU6IGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvIS5uaWNrTmFtZSxcbiAgICAgICAgICAgICAgICBhdmF0YXJVcmw6IGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvIS5hdmF0YXJVcmwsXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB3eC5oaWRlTG9hZGluZygpO1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6ICflt7Lkv53lrZgnLFxuICAgICAgICAgICAgaWNvbjogJ3N1Y2Nlc3MnLFxuICAgICAgICAgICAgZHVyYXRpb246IDEwMDBcbiAgICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgICAvLyBUT0RPOiBzYXZlIHVzZXIgdG8gc2VydmVyIGxvZ2ljXG4gICAgICAgIHd4LnJlcXVlc3Qoe1xuICAgICAgICAgICAgdXJsOiBcImh0dHBzOi8veHh4eHgveHh4XCIsXG4gICAgICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICAgICAgZGF0YTogXCJcIlxuICAgICAgICB9KVxuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gbG9hZFVzZXJJbmZvKCkge1xuICAgIGlmIChhcHAuZ2xvYmFsRGF0YS51c2VDbG91ZCAmJiBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQpIHtcbiAgICAgICAgY29uc3QgZGIgPSB3eC5jbG91ZC5kYXRhYmFzZSgpO1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgZGIuY29sbGVjdGlvbihcInVzZXJzXCIpLmRvYyhhcHAuZ2xvYmFsRGF0YS5vcGVuaWQpLmdldCgpO1xuICAgICAgICBjb25zb2xlLmxvZyhyZXMuZGF0YSk7XG4gICAgICAgIHJldHVybiByZXMuZGF0YTtcbiAgICB9IGVsc2Uge1xuICAgICAgICAvLyBUT0RPOiBsb2FkIHVzZXIgZnJvbSBzZXJ2ZXIgbG9naWNcbiAgICAgICAgd3gucmVxdWVzdCh7XG4gICAgICAgICAgICB1cmw6IFwiaHR0cHM6Ly94eHh4eC94eHhcIixcbiAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgICAgICBkYXRhOiBcImluZm9cIlxuICAgICAgICB9KVxuXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vdCBpbXBsZW1lbnRlZC5cIilcblxuICAgIH1cbn1cblxuXG5hc3luYyBmdW5jdGlvbiBnZXRQaG9uZU51bWJlckNsb3VkKGNvZGU6IHN0cmluZykge1xuICAgIGxldCByZXQgPSBhd2FpdCB3eC5jbG91ZC5jYWxsRnVuY3Rpb24oe1xuICAgICAgICAgICAgbmFtZTogXCJ1cGRhdGVQaG9uZU51bWJlclwiLFxuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIG9wZW5pZDogYXBwLmdsb2JhbERhdGEub3BlbmlkLFxuICAgICAgICAgICAgICAgIHBob25lTnVtYmVyOiB3eC5jbG91ZC5jbG91ZElEKGNvZGUpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIHJldHVybiByZXQucmVzdWx0O1xufSBcblxuYXN5bmMgZnVuY3Rpb24gZ2V0UGhvbmVOdW1iZXJTZXJ2ZXIoZW5jcnlwdGVkRGF0YTogc3RyaW5nLCBpdjogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KT0+e1xuICAgICAgICB3eC5yZXF1ZXN0KHtcbiAgICAgICAgICAgIHVybDogXCJodHRwOi8veHh4eC94eHhcIixcbiAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgb3BlbmlkOiBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQsXG4gICAgICAgICAgICAgICAgZW5jcnlwdGVkRGF0YTogZW5jcnlwdGVkRGF0YSxcbiAgICAgICAgICAgICAgICBpdjogaXZcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdWNjZXNzOiAocmVzKT0+e1xuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzLmRhdGEpICAgIFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZhaWw6IGVyciA9PntcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSlcbiAgICBcbn0iXX0=