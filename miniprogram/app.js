"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
App({
    globalData: {
        useCloud: true
    },
    onLaunch() {
        if (!wx.cloud) {
            console.error('请使用 2.2.3 或以上的基础库以使用云能力');
        }
        else {
            wx.cloud.init({
                traceUser: true,
            });
        }
    },
    ensureLogin() {
        return new Promise((resolve, reject) => {
            if (this.globalData.openid !== null && typeof (this.globalData.openid) !== "undefined") {
                wx.checkSession({
                    success: () => {
                        resolve(this.globalData.openid);
                    },
                    fail: () => {
                        doLogin().then(openid => { resolve(openid); }).catch((err) => { reject(err); });
                    }
                });
            }
            else {
                doLogin().then(openid => { resolve(openid); }).catch(err => { reject(err); });
            }
        });
    },
    getUserInfo() {
        return new Promise((resolve, reject) => {
            wx.getSetting({
                success: res => {
                    if (res.authSetting["scope.userInfo"]) {
                        updateUserInfo().then((info) => {
                            resolve(info);
                        });
                    }
                    else {
                        this.ensureLogin().then(() => {
                            return updateUserInfo()
                                .then((info) => {
                                resolve(info);
                            });
                        });
                    }
                },
                fail: err => {
                    reject(err);
                }
            });
        });
    }
});
function doLogin() {
    const app = getApp();
    return new Promise((resolve, reject) => {
        wx.login({
            success: res => {
                if (res.code) {
                    if (app.globalData.useCloud) {
                        getOpenIDCloud().then(openid => {
                            resolve(openid);
                        });
                    }
                    else {
                        getOpenIDServer(res.code).then(openid => {
                            resolve(openid);
                        });
                    }
                }
            },
            fail: err => {
                reject(err);
            }
        });
    });
}
function getOpenIDCloud() {
    return new Promise((resolve, reject) => {
        const app = getApp();
        wx.cloud.callFunction({
            name: 'login',
            data: {},
            success: res => {
                console.log('[云函数] [login] user openid: ', res.result);
                let openid = res.result.openid;
                app.globalData.openid = openid;
                resolve(openid);
            },
            fail: err => {
                console.error('[云函数] [login] 调用失败', err);
                reject(err);
            }
        });
    });
}
function getOpenIDServer(code) {
    return new Promise((resolve, reject) => {
        const app = getApp();
        wx.request({
            url: 'https:/xxxxx/xxxx',
            data: {
                code: code
            },
            success: res => {
                app.globalData.openid = res.data.openid;
                resolve(res.data);
            },
            fail: err => {
                reject(err);
            }
        });
    });
}
function updateUserInfo() {
    return new Promise((resolve, reject) => {
        const app = getApp();
        wx.getUserInfo({
            success: res => {
                app.globalData.userInfo = res.userInfo;
                resolve(res.userInfo);
            },
            fail: err => {
                reject(err);
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBa0JBLEdBQUcsQ0FBQztJQUNGLFVBQVUsRUFBRTtRQUNWLFFBQVEsRUFBRSxJQUFJO0tBQ0s7SUFDckIsUUFBUTtRQUNOLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO1NBQ3pDO2FBQU07WUFDTCxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztnQkFDWixTQUFTLEVBQUUsSUFBSTthQUNoQixDQUFDLENBQUE7U0FHSDtJQUNILENBQUM7SUFFRCxXQUFXO1FBQ1QsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxLQUFLLElBQUksSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxXQUFXLEVBQUU7Z0JBQ3RGLEVBQUUsQ0FBQyxZQUFZLENBQUM7b0JBQ2QsT0FBTyxFQUFFLEdBQUcsRUFBRTt3QkFDWixPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDbEMsQ0FBQztvQkFDRCxJQUFJLEVBQUUsR0FBRyxFQUFFO3dCQUNULE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2hGLENBQUM7aUJBQ0YsQ0FBQyxDQUFBO2FBQ0g7aUJBQU07Z0JBQ0wsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDN0U7UUFDSCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRCxXQUFXO1FBQ1QsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxFQUFFLENBQUMsVUFBVSxDQUFDO2dCQUNaLE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRTtvQkFDYixJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsRUFBRTt3QkFDckMsY0FBYyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7NEJBQzdCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDaEIsQ0FBQyxDQUFDLENBQUE7cUJBQ0g7eUJBQU07d0JBQ0wsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7NEJBQzNCLE9BQU8sY0FBYyxFQUFFO2lDQUNwQixJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQ0FDYixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQ2hCLENBQUMsQ0FBQyxDQUFBO3dCQUNOLENBQUMsQ0FBQyxDQUFDO3FCQUNKO2dCQUNILENBQUM7Z0JBQ0QsSUFBSSxFQUFFLEdBQUcsQ0FBQyxFQUFFO29CQUNWLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDZCxDQUFDO2FBQ0YsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7SUFFSixDQUFDO0NBRUYsQ0FBQyxDQUFBO0FBc0VGLFNBQVMsT0FBTztJQUNkLE1BQU0sR0FBRyxHQUFHLE1BQU0sRUFBVSxDQUFDO0lBQzdCLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDckMsRUFBRSxDQUFDLEtBQUssQ0FBQztZQUNQLE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDYixJQUFJLEdBQUcsQ0FBQyxJQUFJLEVBQUU7b0JBQ1osSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRTt3QkFFM0IsY0FBYyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFOzRCQUM3QixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7d0JBQ2xCLENBQUMsQ0FBQyxDQUFDO3FCQUNKO3lCQUFNO3dCQUNMLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFOzRCQUN0QyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7d0JBQ2xCLENBQUMsQ0FBQyxDQUFDO3FCQUNKO2lCQUNGO1lBQ0gsQ0FBQztZQUNELElBQUksRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDVixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDZCxDQUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBR0QsU0FBUyxjQUFjO0lBQ3JCLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDckMsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFVLENBQUM7UUFFN0IsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7WUFDcEIsSUFBSSxFQUFFLE9BQU87WUFDYixJQUFJLEVBQUUsRUFBRTtZQUNSLE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDYixPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDdkQsSUFBSSxNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQy9CLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtnQkFDOUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2xCLENBQUM7WUFDRCxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQ1YsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLENBQUMsQ0FBQTtnQkFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2QsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUwsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLElBQVk7SUFFbkMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNyQyxNQUFNLEdBQUcsR0FBRyxNQUFNLEVBQVUsQ0FBQztRQUM3QixFQUFFLENBQUMsT0FBTyxDQUFDO1lBQ1QsR0FBRyxFQUFFLG1CQUFtQjtZQUN4QixJQUFJLEVBQUU7Z0JBQ0osSUFBSSxFQUFFLElBQUk7YUFDWDtZQUNELE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDYixHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUNuQixDQUFDO1lBQ0QsSUFBSSxFQUFFLEdBQUcsQ0FBQyxFQUFFO2dCQUNWLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNkLENBQUM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFFRCxTQUFTLGNBQWM7SUFDckIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNyQyxNQUFNLEdBQUcsR0FBRyxNQUFNLEVBQVUsQ0FBQztRQUM3QixFQUFFLENBQUMsV0FBVyxDQUFDO1lBQ2IsT0FBTyxFQUFFLEdBQUcsQ0FBQyxFQUFFO2dCQUNiLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7Z0JBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDeEIsQ0FBQztZQUNELElBQUksRUFBRSxHQUFHLENBQUMsRUFBRTtnQkFDVixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDZCxDQUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGludGVyZmFjZSBJTXlBcHBHbG9iYWxEYXRhIHtcclxuICB1c2VySW5mbz86IHd4LlVzZXJJbmZvLFxyXG4gIHVzZUNsb3VkOiBib29sZWFuLFxyXG4gIG9wZW5pZD86IHN0cmluZyxcclxuICBwaG9uZU51bWJlcj86IHN0cmluZyxcclxuICB0ZXN0Pzogc3RyaW5nIHwgb2JqZWN0LFxyXG4gIFtrZXk6IHN0cmluZ106IGFueVxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElNeUFwcCB7XHJcbiAgdXNlckluZm9SZWFkeUNhbGxiYWNrPyhyZXM6IHd4LlVzZXJJbmZvKTogdm9pZDtcclxuXHJcbiAgZ2xvYmFsRGF0YTogSU15QXBwR2xvYmFsRGF0YTtcclxuXHJcbiAgZW5zdXJlTG9naW4oKTogUHJvbWlzZTxhbnk+O1xyXG4gIGdldFVzZXJJbmZvKCk6IFByb21pc2U8YW55PjtcclxufVxyXG5cclxuQXBwKHtcclxuICBnbG9iYWxEYXRhOiB7XHJcbiAgICB1c2VDbG91ZDogdHJ1ZVxyXG4gIH0gYXMgSU15QXBwR2xvYmFsRGF0YSxcclxuICBvbkxhdW5jaCgpIHtcclxuICAgIGlmICghd3guY2xvdWQpIHtcclxuICAgICAgY29uc29sZS5lcnJvcign6K+35L2/55SoIDIuMi4zIOaIluS7peS4iueahOWfuuehgOW6k+S7peS9v+eUqOS6keiDveWKmycpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB3eC5jbG91ZC5pbml0KHtcclxuICAgICAgICB0cmFjZVVzZXI6IHRydWUsXHJcbiAgICAgIH0pXHJcblxyXG5cclxuICAgIH1cclxuICB9LFxyXG5cclxuICBlbnN1cmVMb2dpbigpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLmdsb2JhbERhdGEub3BlbmlkICE9PSBudWxsICYmIHR5cGVvZiAodGhpcy5nbG9iYWxEYXRhLm9wZW5pZCkgIT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICB3eC5jaGVja1Nlc3Npb24oe1xyXG4gICAgICAgICAgc3VjY2VzczogKCkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKHRoaXMuZ2xvYmFsRGF0YS5vcGVuaWQpO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGZhaWw6ICgpID0+IHtcclxuICAgICAgICAgICAgZG9Mb2dpbigpLnRoZW4ob3BlbmlkID0+IHsgcmVzb2x2ZShvcGVuaWQpIH0pLmNhdGNoKChlcnIpID0+IHsgcmVqZWN0KGVycikgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBkb0xvZ2luKCkudGhlbihvcGVuaWQgPT4geyByZXNvbHZlKG9wZW5pZCkgfSkuY2F0Y2goZXJyID0+IHsgcmVqZWN0KGVycikgfSk7XHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfSxcclxuXHJcbiAgZ2V0VXNlckluZm8oKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB3eC5nZXRTZXR0aW5nKHtcclxuICAgICAgICBzdWNjZXNzOiByZXMgPT4ge1xyXG4gICAgICAgICAgaWYgKHJlcy5hdXRoU2V0dGluZ1tcInNjb3BlLnVzZXJJbmZvXCJdKSB7XHJcbiAgICAgICAgICAgIHVwZGF0ZVVzZXJJbmZvKCkudGhlbigoaW5mbykgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmVuc3VyZUxvZ2luKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVVzZXJJbmZvKClcclxuICAgICAgICAgICAgICAgIC50aGVuKChpbmZvKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGZhaWw6IGVyciA9PiB7XHJcbiAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG5cclxuICB9XHJcblxyXG59KVxyXG5cclxuLy8gY2xhc3MgbXlBcHAgaW1wbGVtZW50cyBJTXlBcHAge1xyXG4vLyAgIGdsb2JhbERhdGE6IElNeUFwcEdsb2JhbERhdGEgPSB7XHJcbi8vICAgICB1c2VDbG91ZDogdHJ1ZSxcclxuXHJcbi8vICAgfVxyXG5cclxuLy8gICBhc3luYyBvbkxhdW5jaCgpIHtcclxuLy8gICAgIGlmICghd3guY2xvdWQpIHtcclxuLy8gICAgICAgY29uc29sZS5lcnJvcign6K+35L2/55SoIDIuMi4zIOaIluS7peS4iueahOWfuuehgOW6k+S7peS9v+eUqOS6keiDveWKmycpXHJcbi8vICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICB3eC5jbG91ZC5pbml0KHtcclxuLy8gICAgICAgICB0cmFjZVVzZXI6IHRydWUsXHJcbi8vICAgICAgIH0pXHJcblxyXG5cclxuLy8gICAgIH1cclxuLy8gICAgIC8vIHRyeSB7XHJcbi8vICAgICAvLyAgIGF3YWl0IHRoaXMuZ2V0VXNlckluZm8oKVxyXG4vLyAgICAgLy8gfSBjYXRjaCAoZXJyKSB7XHJcbi8vICAgICAvLyAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcclxuLy8gICAgIC8vIH1cclxuLy8gICAgIC8vIGF3YWl0IHRoaXMuZ2V0VXNlckluZm8oKTtcclxuLy8gICB9XHJcblxyXG4vLyAgIGVuc3VyZUxvZ2luKCkge1xyXG4vLyAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuLy8gICAgICAgaWYgKHRoaXMuZ2xvYmFsRGF0YS5vcGVuaWQgIT09IG51bGwgJiYgdHlwZW9mICh0aGlzLmdsb2JhbERhdGEub3BlbmlkKSAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4vLyAgICAgICAgIHd4LmNoZWNrU2Vzc2lvbih7XHJcbi8vICAgICAgICAgICBzdWNjZXNzOiAoKSA9PiB7XHJcbi8vICAgICAgICAgICAgIHJlc29sdmUodGhpcy5nbG9iYWxEYXRhLm9wZW5pZCk7XHJcbi8vICAgICAgICAgICB9LFxyXG4vLyAgICAgICAgICAgZmFpbDogKCkgPT4ge1xyXG4vLyAgICAgICAgICAgICBkb0xvZ2luKCkudGhlbihvcGVuaWQgPT4geyByZXNvbHZlKG9wZW5pZCkgfSkuY2F0Y2goKGVycikgPT4geyByZWplY3QoZXJyKSB9KTtcclxuLy8gICAgICAgICAgIH1cclxuLy8gICAgICAgICB9KVxyXG4vLyAgICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICAgIGRvTG9naW4oKS50aGVuKG9wZW5pZCA9PiB7IHJlc29sdmUob3BlbmlkKSB9KS5jYXRjaChlcnIgPT4geyByZWplY3QoZXJyKSB9KTtcclxuLy8gICAgICAgfVxyXG4vLyAgICAgfSlcclxuLy8gICB9XHJcblxyXG4vLyAgIGdldFVzZXJJbmZvKCkge1xyXG4vLyAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuLy8gICAgICAgd3guZ2V0U2V0dGluZyh7XHJcbi8vICAgICAgICAgc3VjY2VzczogcmVzID0+IHtcclxuLy8gICAgICAgICAgIGlmIChyZXMuYXV0aFNldHRpbmdbXCJzY29wZS51c2VySW5mb1wiXSkge1xyXG4vLyAgICAgICAgICAgICB1cGRhdGVVc2VySW5mbygpLnRoZW4oKGluZm8pID0+IHtcclxuLy8gICAgICAgICAgICAgICByZXNvbHZlKGluZm8pO1xyXG4vLyAgICAgICAgICAgICB9KVxyXG4vLyAgICAgICAgICAgfSBlbHNlIHtcclxuLy8gICAgICAgICAgICAgdGhpcy5lbnN1cmVMb2dpbigpLnRoZW4oKCkgPT4ge1xyXG4vLyAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVVc2VySW5mbygpXHJcbi8vICAgICAgICAgICAgICAgICAudGhlbigoaW5mbykgPT4ge1xyXG4vLyAgICAgICAgICAgICAgICAgICByZXNvbHZlKGluZm8pO1xyXG4vLyAgICAgICAgICAgICAgICAgfSlcclxuLy8gICAgICAgICAgICAgfSk7XHJcbi8vICAgICAgICAgICB9XHJcbi8vICAgICAgICAgfSxcclxuLy8gICAgICAgICBmYWlsOiBlcnIgPT4ge1xyXG4vLyAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbi8vICAgICAgICAgfVxyXG4vLyAgICAgICB9KVxyXG4vLyAgICAgfSlcclxuXHJcbi8vICAgfVxyXG4vLyB9XHJcblxyXG5cclxuZnVuY3Rpb24gZG9Mb2dpbigpIHtcclxuICBjb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICB3eC5sb2dpbih7XHJcbiAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgaWYgKHJlcy5jb2RlKSB7XHJcbiAgICAgICAgICBpZiAoYXBwLmdsb2JhbERhdGEudXNlQ2xvdWQpIHtcclxuXHJcbiAgICAgICAgICAgIGdldE9wZW5JRENsb3VkKCkudGhlbihvcGVuaWQgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUob3BlbmlkKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBnZXRPcGVuSURTZXJ2ZXIocmVzLmNvZGUpLnRoZW4ob3BlbmlkID0+IHtcclxuICAgICAgICAgICAgICByZXNvbHZlKG9wZW5pZCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgZmFpbDogZXJyID0+IHtcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBnZXRPcGVuSURDbG91ZCgpIHtcclxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgY29uc3QgYXBwID0gZ2V0QXBwPElNeUFwcD4oKTtcclxuXHJcbiAgICB3eC5jbG91ZC5jYWxsRnVuY3Rpb24oe1xyXG4gICAgICBuYW1lOiAnbG9naW4nLFxyXG4gICAgICBkYXRhOiB7fSxcclxuICAgICAgc3VjY2VzczogcmVzID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZygnW+S6keWHveaVsF0gW2xvZ2luXSB1c2VyIG9wZW5pZDogJywgcmVzLnJlc3VsdCk7XHJcbiAgICAgICAgbGV0IG9wZW5pZCA9IHJlcy5yZXN1bHQub3BlbmlkO1xyXG4gICAgICAgIGFwcC5nbG9iYWxEYXRhLm9wZW5pZCA9IG9wZW5pZFxyXG4gICAgICAgIHJlc29sdmUob3BlbmlkKTtcclxuICAgICAgfSxcclxuICAgICAgZmFpbDogZXJyID0+IHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdb5LqR5Ye95pWwXSBbbG9naW5dIOiwg+eUqOWksei0pScsIGVycilcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRPcGVuSURTZXJ2ZXIoY29kZTogc3RyaW5nKSB7XHJcbiAgLy8gVE9ETzogaW1wbGVtZW50IFxyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBjb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpO1xyXG4gICAgd3gucmVxdWVzdCh7XHJcbiAgICAgIHVybDogJ2h0dHBzOi94eHh4eC94eHh4JyxcclxuICAgICAgZGF0YToge1xyXG4gICAgICAgIGNvZGU6IGNvZGVcclxuICAgICAgfSxcclxuICAgICAgc3VjY2VzczogcmVzID0+IHtcclxuICAgICAgICBhcHAuZ2xvYmFsRGF0YS5vcGVuaWQgPSByZXMuZGF0YS5vcGVuaWQ7XHJcbiAgICAgICAgcmVzb2x2ZShyZXMuZGF0YSlcclxuICAgICAgfSxcclxuICAgICAgZmFpbDogZXJyID0+IHtcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlVXNlckluZm8oKSB7XHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGNvbnN0IGFwcCA9IGdldEFwcDxJTXlBcHA+KCk7XHJcbiAgICB3eC5nZXRVc2VySW5mbyh7XHJcbiAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XHJcbiAgICAgICAgYXBwLmdsb2JhbERhdGEudXNlckluZm8gPSByZXMudXNlckluZm87XHJcbiAgICAgICAgcmVzb2x2ZShyZXMudXNlckluZm8pO1xyXG4gICAgICB9LFxyXG4gICAgICBmYWlsOiBlcnIgPT4ge1xyXG4gICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9KVxyXG59XHJcblxyXG5cclxuIl19